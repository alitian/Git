<?php

if (!defined('BASEPATH'))
    exit('No direct script access allowed');

class Counter extends Deamon_Controller {

    public function __construct() {
        parent::__construct();
        $this->load->model('product_model');
    }

    /**
     * 修正产品计数
     */
    public function product() {
        $this->load->model('base/product_base');
        //获取正在众筹的项目，结束的项目走归档数据
        $sql = "SELECT id FROM md_product WHERE if_show=1 AND end_time>'" . date("Y-m-d H:i:s") . "'";
        $pro_list = $this->db->query($sql)->result_array();
        foreach ($pro_list as $item) {
            $obj_product = $this->product_base->get_by_id($item['id']);
            //支持人数
            $obj_product->backer_count = $this->product_model->get_backer_count($item['id']);
            //订单数
            $obj_product->back_count = $this->product_model->get_back_count($item['id']);
            //支持金额
            $obj_product->backer_money = $this->product_model->get_backer_money($item['id']);
            $obj_product->save();
        }
        //更新数
        $sql = "select pro_id from md_product_update WHERE if_show=1 AND ctime>'" . date("Y-m-d H:00:00") . "' group by pro_id";
        $update_list = $this->db->query($sql)->result_array();

        foreach ($update_list as $item) {
            $obj_product = $this->product_base->get_by_id($item['id']);
            $obj_product->update_count = $this->product_model->get_updates_count($item['pro_id']);
            $obj_product->save();
        }
        echo 'update pro count: ' . count($pro_list) . '. updates count:' . count($update_list);
    }

    /**
     * 修正回报
     */
    public function product_rewards() {
        $this->load->model('base/product_rewards_base');
        $sql = "SELECT rew.id FROM md_product pro
INNER JOIN md_product_rewards rew ON pro.id=rew.pro_id AND rew.if_show=1
WHERE pro.if_show=1 AND pro.end_time>'" . date("Y-m-d H:i:s") . "'";
        //支持人数
        $rew_list = $this->db->query($sql)->result_array();
        foreach ($rew_list as $item) {
            $obj_reward = $this->product_rewards_base->get_by_id($item['id']);
            $sql = "SELECT count(1) as c FROM md_product_back WHERE if_pay=1 AND rew_id='{$item['id']}'";
            $res = $this->db->query($sql)->row_array();
            $obj_reward->back_count = $res['c'];
            $obj_reward->save();
        }
    }

}
