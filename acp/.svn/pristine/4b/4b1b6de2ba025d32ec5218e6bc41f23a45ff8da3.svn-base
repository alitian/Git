<?php

if (!defined('BASEPATH'))
    exit('No direct script access allowed');

require_once BASEPATH . 'libraries/md_memcache.php';

class Weidashang extends Acp_Controller {

    public function __construct() {
        parent::__construct();
        $this->db->read_main = true;
        $this->load->helper('url');
        $this->load->helper('util');
        $this->load->helper('excel');
        $this->load->library('md_model_cache');
        $this->load->library('md_payment_batch_draw');
        $this->load->library('md_payment_weixin');
        $this->load->library('md_weidashang');
        $this->load->model('User_m');
        $this->load->library('md_refund');
        $this->load->model('Order_biz');
        $this->load->model('Wds_acp_m');
        $this->load->library('md_common');
        $this->load->model('Common');
        $this->load->library('md_imagick');
        $this->load->library('md_payment_ali_draw');
    }

    /**
     * 微打赏首页推荐区
     */
    function ajax_topic_sort() {
        ##批量修改排序        
        if ($_POST['topic_sort_arr']) {
            $sort_topic = json_decode($_POST['topic_sort_arr'], true);
            $topic_id = json_decode($_POST['topic_id_arr'], true);
            for ($i = 0; $i < count($sort_topic); $i++) {
                $sort_sql = "update md_weidashang_topic SET sort={$sort_topic[$i]}  WHERE id ={$topic_id[$i]}";
                $this->db->query($sort_sql);
            }
            echo json_encode(array('status' => '1'));
        } else {
            echo json_encode(array('status' => '-1'));
        }
    }

    public function wds_first_recom() {
        set_time_limit(0);
        ##首页活动项目增加排序
        if (isset($_POST['topic_id'])) {
            $add_topicsql = "update md_weidashang_topic SET if_recommend=1,if_show=1  WHERE id ='" . $_POST['topic_id'] . "'";
            $this->db->query($add_topicsql);
            redirect('weidashang/wds_first_recom');
        }
        ##某一个活动取消排序展示
        if (isset($_GET['id'])) {
            $del_sql = "update md_weidashang_topic SET if_show=0  WHERE id ='" . $_GET['id'] . "';";
            $this->db->query($del_sql);
            redirect('weidashang/wds_first_recom');
        }
        ##首页活动区是否展示
        if (isset($_GET['hide_topic'])) {
            if ($_GET['hide_topic'] == 0) {
                $sql = "update md_weidashang_topic SET if_show=0  WHERE 1;";
                $this->db->query($sql);
            } elseif ($_GET['hide_topic'] == 1) {
                $sql = "update md_weidashang_topic SET if_show=1  WHERE 1;";
                $this->db->query($sql);
            }
            redirect('weidashang/wds_first_recom');
        }
        ##首页活动排序修改立即生效
        if (isset($_GET['del_mem'])) {
            $this->load->library('wds_mem');
            wds_mem::del_wds_mem();
            redirect('weidashang/wds_first_recom');
        }
        ##某一个活动项目的修改;获取相应内容
        if (isset($_GET['edit_id'])) {
            $topic_sql = "SELECT * FROM md_weidashang_topic WHERE id={$_GET['edit_id']}";
            $topic_mes = $this->db->query($topic_sql)->row_array();
            $data['topic_mes'] = $topic_mes;
            $data['topic_mes']['rec_pic'] = cdn_url($topic_mes['logo']);
            $data['topic_mes']['topic_link'] = _gc('domain_weidashang', 'domain') . '/weidashang_topic/' . $topic_mes['id'];
        }
        $sql = "SELECT * FROM md_weidashang_topic WHERE if_show=1 AND if_recommend=1 ORDER BY sort DESC,id DESC";
        $data['projects'] = $this->db->query($sql)->result_array();
        for ($i = 0; $i < count($data['projects']); $i++) {
            $data['projects'][$i]['recom_pic'] = cdn_url($data['projects'][$i]['logo'], 'mp', 'center');
            $data['projects'][$i]['link'] = _gc('domain_weidashang', 'domain') . '/weidashang_topic/' . $data['projects'][$i]['id'];
        }
        //print_r($data);exit;
        $this->load->view('weidashang/huodong_recommend', $data);
    }

    function add_edit_topic() {
        $topic_id = $_POST['edit_topic_id'];
        $new_topic_name = $_POST['new_topic_name'];
        $new_logo = $_POST['topic_pic_hidden'];
        $uptopic_mes_sql = "update md_weidashang_topic SET topic='{$new_topic_name}',logo='{$new_logo}'  WHERE id={$topic_id}";
        $this->db->query($uptopic_mes_sql);
        echo json_encode(array('status' => '1'));
    }

    function upload_topic_pic() {
        $picture = "";
        if ($_FILES["topic_picture"]) {
            if ($_FILES["topic_picture"]["name"]) {
                $exten = $this->Common->get_extension($_FILES["topic_picture"]["name"]);
                $str = date("Ymd");
                $t1 = date("Ymd", time());
                if (!is_dir(config_item('uploads_path') . "diandian/{$t1}")) {
                    mkdir(config_item('uploads_path') . "diandian/{$t1}", 0755, true);
                }
                $filename = 'focus_' . $str . "_" . time() . "_" . rand(1000, 9999);
                $to = 'diandian/' . $t1 . '/' . $filename . $exten;
                $picture = md_imagick::do_upload($_FILES["topic_picture"]["tmp_name"], config_item('uploads_path') . $to);
                //echo "<script>parent.callback('right|" . $logo . "')</script>";
                //exit;
            } else {
                //md_common::display_javascript("请选择正确的文件", "reload");
                echo "<script>alert('请选择正确的文件');</script>";
                exit;
            }
        }
        //var_dump($_FILES["topic_picture"]);
        if ($picture) {
            $data["pro_picture"] = str_replace(config_item('uploads_path'), "", $picture);
            echo json_encode(array("num" => "1", "pic" => $data["pro_picture"]));
        } else {
            echo json_encode(array("num" => "2", "pic" => ""));
        }
    }

    /**
     * 首页项目推荐
     */
    function ajax_wds_sort() {
        if ($_POST['wds_sort_arr']) {
            $sort_wds = json_decode($_POST['wds_sort_arr'], true);
            $wds_id = json_decode($_POST['wds_id_arr'], true);
            for ($i = 0; $i < count($sort_wds); $i++) {
                $sort_sql = "update md_weidashang_product SET list_num={$sort_wds[$i]}  WHERE id ={$wds_id[$i]}";
                $this->db->query($sort_sql);
            }
            echo json_encode(array('status' => '1'));
        } else {
            echo json_encode(array('status' => '-1'));
        }
    }

    public function weidashang_pro_manage() {
        set_time_limit(0);
        if ($_POST) {
            ##添加项目推荐
            if (isset($_POST['wds_id'])) {
                $sql = "update md_weidashang_product SET flag=REPLACE(flag,',homepage_going','')  WHERE id ='" . $_POST['wds_id'] . "';";
                $this->db->query($sql);
                $sql = "update md_weidashang_product SET flag=CONCAT(flag,',homepage_going')  WHERE id ='" . $_POST['wds_id'] . "';";
                $this->db->query($sql);
            }
        }
        ##取消项目推荐
        if (isset($_GET['del_id'])) {
            $sql = "update md_weidashang_product SET flag='', list_num=0  WHERE id ='" . $_GET['del_id'] . "';";
            $this->db->query($sql);
            redirect('weidashang/weidashang_pro_manage');
        }
        ##首页项目排序修改立即生效
        if (isset($_GET['del_mem'])) {
            $this->load->library('wds_mem');
            wds_mem::del_wds_mem();
            redirect('weidashang/weidashang_pro_manage');
        }
        ##某一个项目的修改;获取相应内容
        if (isset($_GET['edit_id'])) {
            $wds_sql = "SELECT * FROM md_weidashang_product WHERE id={$_GET['edit_id']}";
            $wds_mes = $this->db->query($wds_sql)->row_array();
            $data['wds_mes'] = $wds_mes;
            $data['wds_mes']['rec_pic'] = cdn_url($wds_mes['first_figure']);
            $data['wds_mes']['topic_link'] = _gc('domain_weidashang', 'domain') . '/show_weidashang_pro/' . $wds_mes['id'];
        }
        $sql = "SELECT * FROM md_weidashang_product WHERE if_show=1 AND pro_type=3 AND flag LIKE '%homepage_going%' ORDER BY list_num DESC,id DESC";
        $data['projects'] = $this->db->query($sql)->result_array();
        for ($i = 0; $i < count($data['projects']); $i++) {
            if ($data['projects'][$i]['type_id'] == 0) {
                $data['projects'][$i]['wds_type'] = '活动项目';
            } elseif ($data['projects'][$i]['type_id'] == -1) {
                $data['projects'][$i]['wds_type'] = '独立项目';
            }
            $data['projects'][$i]['recom_pic'] = cdn_url($data['projects'][$i]['first_figure'], 'mp', 'center');
            $data['projects'][$i]['link'] = _gc('domain_weidashang', 'domain') . '/show_weidashang_pro/' . $data['projects'][$i]['id'];
        }
        $this->load->view('weidashang/weidashang_pro_manage', $data);
    }

    function add_edit_wds() {
        $wds_id = $_POST['edit_wds_id'];
        $new_wds_name = $_POST['new_wds_name'];
        $new_logo = $_POST['wds_pic_hidden'];
        $upwds_mes_sql = "update md_weidashang_product SET name='{$new_wds_name}',first_figure='{$new_logo}'  WHERE id={$wds_id}";
        $this->db->query($upwds_mes_sql);
        echo json_encode(array('status' => '1'));
    }

    function upload_wds_pic() {
        $picture = "";
        if ($_FILES["wds_picture"]) {
            if ($_FILES["wds_picture"]["name"]) {
                $exten = $this->Common->get_extension($_FILES["wds_picture"]["name"]);
                $str = date("Ymd");
                $t1 = date("Ymd", time());
                if (!is_dir(config_item('uploads_path') . "weidashang/" . date('Y') . '/' . date('m') . '/' . date('d'))) {
                    mkdir(config_item('uploads_path') . "weidashang/" . date('Y') . '/' . date('m') . '/' . date('d'), 0755, true);
                }
                $filename = 'focus_' . $str . "_" . time() . "_" . rand(1000, 9999);
                $to = 'weidashang/' . date('Y') . "/" . date('m') . "/" . date('d') . '/' . $filename . $exten;
                $picture = md_imagick::web_upload($_FILES["wds_picture"]["tmp_name"], config_item('uploads_path') . $to);
                //echo "<script>parent.callback('right|" . $logo . "')</script>";
                //exit;
            } else {
                //md_common::display_javascript("请选择正确的文件", "reload");
                echo "<script>alert('请选择正确的文件');</script>";
                exit;
            }
        }
        //var_dump($_FILES["topic_picture"]);
        if ($picture) {
            $data["pro_picture"] = str_replace(config_item('uploads_path'), "", $picture['pic']);
            echo json_encode(array("num" => "1", "pic" => $data["pro_picture"]));
        } else {
            echo json_encode(array("num" => "2", "pic" => ""));
        }
    }

    function ajax_carouse_sort() {
        if ($_POST['carouse_sort_arr']) {
            $sort_carouse = json_decode($_POST['carouse_sort_arr'], true);
            $carouse_id = json_decode($_POST['carouse_id_arr'], true);
            for ($i = 0; $i < count($sort_carouse); $i++) {
                $sort_sql = "update md_weidashang_topic_recom SET sort={$sort_carouse[$i]}  WHERE id ={$carouse_id[$i]}";
                $this->db->query($sort_sql);
            }
            echo json_encode(array('status' => '1'));
        } else {
            echo json_encode(array('status' => '-1'));
        }
    }

    public function wds_carouse_pic() {
        $data = array();
//        if ($_POST) {           
//            ##添加项目推荐
//            if (isset($_POST['carouse_id'])) {
//                $sql = "update md_weidashang_topic_recom SET if_show=1 , if_recommend=1  WHERE id={$_POST['carouse_id']}";
//                $this->db->query($sql);
//            }
//            redirect('weidashang/wds_carouse_pic');
//        }
        ##新增/修改轮播图 查询数据
        if ($_GET['edit_id']) {
            $pic_sql = "SELECT * FROM `md_weidashang_topic_recom` WHERE id={$_GET['edit_id']} ";
            $data['pic_mes'] = $this->db->query($pic_sql)->row_array();
            $data['pic_mes']['carouse_pic'] = cdn_url($data['pic_mes']['recom_pic'], 'mp', 'center');
        }
        ##轮播图取消推荐
        if ($_GET['del_id']) {
            $pic_sql = "update md_weidashang_topic_recom SET if_show=0 , if_recommend=0,sort=0  WHERE id={$_GET['del_id']}";
            $this->db->query($pic_sql);
            redirect('weidashang/wds_carouse_pic');
        }
        ##首页项目排序修改立即生效
        if (isset($_GET['del_mem'])) {
            $this->load->library('wds_mem');
            wds_mem::del_wds_mem();
            redirect('weidashang/wds_carouse_pic');
        }
        $carouse_sql = "SELECT * FROM `md_weidashang_topic_recom` WHERE if_show=1 AND if_recommend=1 ORDER BY sort DESC, id DESC ";
        $data['carouse'] = $this->db->query($carouse_sql)->result_array();
        for ($i = 0; $i < count($data['carouse']); $i++) {
            $data['carouse'][$i]['carouse_pic'] = cdn_url($data['carouse'][$i]['recom_pic'], 'mp', 'center');
        }
        $this->load->view('weidashang/wds_carouse', $data);
    }

    public function deal_carouset_pic() {
        $carouse_id = $_POST['edit_carouse_id'];
        $insert['pic_name'] = $_POST['new_carouse_name'];
        $insert['recom_pic'] = $_POST['carouse_pic_hidden'];
        $insert['pic_intro'] = $_POST['carouse_link'];
        if ($carouse_id == 0 || $carouse_id == '') {
            $insert['user_id'] = $_SESSION['admin_id'];
            $insert['user_name'] = $this->md_refund->get_op_name($_SESSION['admin_id']);
            $insert['ctime'] = date("Y-m-d H:i:s");
            $insert['if_recommend'] = 1;
            $this->db->insert("md_weidashang_topic_recom", $insert);
        } else {
            $upcarouse_sql = "update md_weidashang_topic_recom SET pic_name='{$insert['pic_name']}',recom_pic='{$insert['recom_pic']}',pic_intro='{$insert['pic_intro']}'  WHERE id={$carouse_id}";
            $this->db->query($upcarouse_sql);
        }
        echo json_encode(array('status' => '1'));
    }

    function upload_carouse_pic() {
        $picture = "";
        if ($_FILES["carouse_picture"]) {
            if ($_FILES["carouse_picture"]["name"]) {
                $exten = $this->Common->get_extension($_FILES["carouse_picture"]["name"]);
                $str = date("Ymd");
                $t1 = date("Ymd", time());
                if (!is_dir(config_item('uploads_path') . "wds/carouse/" . date('Y') . '/' . date('m') . '/' . date('d'))) {
                    mkdir(config_item('uploads_path') . "wds/carouse/" . date('Y') . '/' . date('m') . '/' . date('d'), 0755, true);
                }
                $filename = 'focus_' . $str . "_" . time() . "_" . rand(1000, 9999);
                $to = 'wds/carouse/' . date('Y') . "/" . date('m') . "/" . date('d') . '/' . $filename . $exten;
                $picture = md_imagick::web_upload($_FILES["carouse_picture"]["tmp_name"], config_item('uploads_path') . $to);
                //echo "<script>parent.callback('right|" . $logo . "')</script>";
                //exit;
            } else {
                //md_common::display_javascript("请选择正确的文件", "reload");
                echo "<script>alert('请选择正确的文件');</script>";
                exit;
            }
        }
        //var_dump($_FILES["topic_picture"]);
        if ($picture) {
            $data["pro_picture"] = str_replace(config_item('uploads_path'), "", $picture['pic']);
            echo json_encode(array("num" => "1", "pic" => $data["pro_picture"]));
        } else {
            echo json_encode(array("num" => "2", "pic" => ""));
        }
    }

    /**
     * 所有项目管理
     */
    public function wds_all_pro_list() {
        $data = array();
        $this->load->view('weidashang/wds_all_pro', $data);
    }

    public function ajax_wds_all_pro() {
        $res = array();
        $result = array();
        $res = $this->all_pro_search(1);

        $result = array(
            'total' => $res["num"],
            'rows' => $res["search"],
            'footer' => '',
        );

        echo json_encode($result);
    }

    public function all_pro_search() {

        $search_arr["pro_id"] = isset($_POST['pro_id']) ? $_POST['pro_id'] : '';
        $search_arr["pro_name"] = isset($_POST['pro_name']) ? $_POST['pro_name'] : '';
        $search_arr["start_time"] = isset($_POST['start_time']) ? $_POST['start_time'] : '';
        $search_arr["end_time"] = isset($_POST['end_time']) ? $_POST['end_time'] : '';
        $search_arr["bysort"] = isset($_POST['bysort']) ? $_POST['bysort'] : 'id';
        $search_arr["byorder"] = isset($_POST['byorder']) ? $_POST['byorder'] : 'DESC';
        $search_arr["time_status"] = isset($_POST['time_status']) ? $_POST['time_status'] : '';
        $search_arr["pro_status"] = isset($_POST['pro_status']) ? $_POST['pro_status'] : '';
        $search_arr["pro_type"] = isset($_POST['pro_type']) ? $_POST['pro_type'] : '';
        $search_arr["money_status"] = isset($_POST['money_status']) ? $_POST['money_status'] : '';
        $search_arr["province"] = isset($_POST['province']) ? $_POST['province'] : '';
        $search_arr["city"] = isset($_POST['city']) ? $_POST['city'] : '';
        $search_arr["topic_id"] = isset($_POST['topic_id']) ? $_POST['topic_id'] : '';

        $search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
        $search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';

        $start = ($search_arr["page"] > 1) ? ($search_arr["page"] - 1) * $search_arr["rows"] : 0;
        $end = ($search_arr["page"] > 1) ? ($search_arr["page"]) * $search_arr["rows"] : $search_arr["rows"];
        $result = $this->Wds_acp_m->all_pro_serach($search_arr);
        $num = $this->Wds_acp_m->all_pro_serach($search_arr, -1);
        //print_r($result);exit;
        $list_info = array();
        if (!empty($result)) {
            foreach ($result as $key => $val) {
                $res["id"] = $val["id"];
                if ($val["type_id"] == 0) {
                    $res["pro_type"] = "活动项目";
                } elseif ($val["type_id"] == -1) {
                    $res["pro_type"] = "独立项目";
                }
                $res['pro_name'] = $val['name'];
                $res['province'] = $val['province'];
                $res['city'] = $val['city'];
                $logo = cdn_url($val["first_figure"]);
                $res["logo"] = '<img src="' . $logo . '" style="width:80px;height:80px"/>';
                $res["goal"] = $val["goal"];
                $res['start_time'] = $val['start_time'];
                $res['end_time'] = $val['end_time'];
                $res['create_user_id'] = $val['create_user_id'];
                $res['create_user_name'] = isset($val['nickname']) ? $val['nickname'] : $val['username'];
                $res['create_user_mobile'] = $val['user_mobile'];
                $res['create_user_email'] = $val['user_email'];
                $res["pay_count"] = $val["pay_count"];
                $res["all_amount"] = $val["all_amount"];
                $val['name'] = str_replace("'", "\'", $val["name"]);
                $val['name'] = str_replace('"', '&quot;', $val["name"]);
                if ($val['if_show'] == '1') {
                    if($val['if_withdraw'] == 0 && $val['if_refund'] == 0){
                        $res['work'] = ' <a href="/weidashang/edit_wds_pro/' . $val["id"] . '" id="edit_wds_pro">编辑</a> | <a href="/weidashang/down_pro_sub/' . $val["id"] . '" id="down_pro" class="down_pro" onclick="if(confirm(\'确实要将项目<' . $val["name"] . '>下线吗？\')) return true;else return false;">下线</a>';                       
                    }
                } elseif ($val['if_show'] == '0') {
                    if($val['if_withdraw'] == 0 && $val['if_refund'] == 0){
                        $res['work'] = ' <a href="/weidashang/edit_wds_pro/' . $val["id"] . '" id="edit_wds_pro">编辑</a> | <a href="/weidashang/updata_pro_sub/' . $val["id"] . '" id="go_pro" class="go_pro" onclick="if(confirm(\'确实要将项目<' . $val["name"] . '>上线吗？\')) return true;else return false;">上线</a>';                       
                    }
                }
                $list_info[] = $res;
            }
        }

        $allpro_list_info = array();
        $allpro_list_info["search"] = $list_info;
        $allpro_list_info["num"] = $num;
        return $allpro_list_info;
    }

    /**
     * 编辑微打赏项目
     */
    function edit_wds_pro($wds_id=0){
        if(!empty($_POST)){
            $wds_id = isset($_POST['edit_wds_id'])?$_POST['edit_wds_id']:'0';
            $wds_name = isset($_POST['wds_name'])?$_POST['wds_name']:'';
            $wds_start = isset($_POST['wds_start_time'])?$_POST['wds_start_time']:'0000-00-00 00:00:00';
            $wds_end = isset($_POST['wds_end_time'])?$_POST['wds_end_time']:'0000-00-00 00:00:00';
            $wds_goal = isset($_POST['wds_goals'])?$_POST['wds_goals']:'0';
            $duration = (int) ((strtotime($wds_end) - strtotime($wds_start) ) / 3600 / 24);
            $update_data = array(
                'id' => $wds_id,
                'name' => $wds_name,
                'start_time' => $wds_start,
                'end_time' => $wds_end,
                'goal' => $wds_goal,
                'duration' => $duration,
            );
            $this->Wds_acp_m->updata_wds_sub_mess($update_data);
            $this->load->library('wds_mem');
            $view_path = sprintf(wds_mem::WDS_PRO, $wds_id);
            $mem_key = md5($view_path);
            wds_mem::del_wds_status_mes($mem_key);
            echo "<script>alert('基础信息更新成功！');location.replace('/weidashang/wds_all_pro_list/');</script>";
        }
        $data = array();
        $wds_mess = $this->Wds_acp_m->get_wds_sub_mess($wds_id);
        $data['wds_mes'] = $wds_mess;
        $this->load->view('weidashang/edit_wds_pro', $data);
    }
    /**
     * 微打赏项目预览
     * @param type $wds_id
     */
    function proview_wds_pro(){
        if(!empty($_POST)){
            $wds_con_type = isset($_POST['wds_content_type'])?$_POST['wds_content_type']:'1';//1：保存  2：预览
            $wds_id = isset($_POST['edit_wds_id'])?$_POST['edit_wds_id']:'0';
            $wds_name = isset($_POST['wds_name'])?$_POST['wds_name']:'';
            $wds_start = isset($_POST['wds_start_time'])?$_POST['wds_start_time']:'0000-00-00 00:00:00';
            $wds_end = isset($_POST['wds_end_time'])?$_POST['wds_end_time']:'0000-00-00 00:00:00';
            $wds_goal = isset($_POST['wds_goals'])?$_POST['wds_goals']:'0';
            $duration = (int) ((strtotime($wds_end) - strtotime($wds_start) ) / 3600 / 24);
            $content = isset($_POST['content'])?$_POST['content']:'';
            if($wds_con_type == 1){//保存
                $update_data = array(
                    'id' => $wds_id,
                    'name' => $wds_name,
                    'start_time' => $wds_start,
                    'end_time' => $wds_end,
                    'goal' => $wds_goal,
                    'duration' => $duration,
                    'content' => htmlspecialchars($content, ENT_QUOTES),
                );
                $this->Wds_acp_m->updata_wds_sub_mess($update_data);
                $this->load->library('wds_mem');
                $view_path = sprintf(wds_mem::WDS_PRO, $wds_id);
                $mem_key = md5($view_path);
                wds_mem::del_wds_status_mes($mem_key);
                echo "<script>alert('项目更新成功！');location.replace('/weidashang/wds_all_pro_list/');</script>";
            }else{//预览
                $this->load->model('Wds_m');
                $data = array();
                $wds_mess = $this->Wds_acp_m->get_wds_sub_mess($wds_id);
                $pro_pic_arr = unserialize($wds_mess['logo']);
                foreach ($pro_pic_arr as $k => $v) {
                    $pro_pic_arr[$k] = cdn_url($v, 'l');
                }
                //活动融资开始多少天
                if (!empty($wds_start) && $wds_start != '0000-00-00 00:00:00') {
                    $wds_mes['has_started'] = (int) ((time() - strtotime($wds_start)) / 3600 / 24);
                    $wds_mes['remaining_hours'] = $duration * 24 - ceil((time() - strtotime($wds_start)) / 3600);
                    $wds_mes['surplus_days'] = $duration - $wds_mes['has_started'];
                }
                $wds_mes['status'] = '';
                if (empty($wds_mes['status'])) {
                    if ($wds_mess['if_show'] == 1) {
                        if ($wds_mes['has_started'] >= $duration) {
                            $wds_mes['status'] = '已结束';
                        } else {
                            $wds_mes['status'] = '进行中';
                        }
                    } else {
                        $wds_mes['status'] = '已下线';
                    }
                }
                $wds_mes['all_amount'] = $wds_mess['all_amount'];
                $wds_mes['pay_count'] = $wds_mess['pay_count'];
                $wds_mes['name'] = $wds_name;
                $wds_mes['start_time'] = $wds_start;
                $wds_mes['end_time'] = $wds_end;
                $wds_mes['duration'] = $duration;
                $wds_mes['goal'] = $wds_goal;
                $wds_mes['content'] = htmlspecialchars($content, ENT_QUOTES);
                $wds_mes['pro_pic_arr'] = $pro_pic_arr;
                $userinfo = $this->Wds_m->get_user_info($wds_mess['user_id']);
                $wds_mes['userinfo'] = $userinfo;
                if ($wds_mess['type_id'] == 0) {
                    $topic_sql = "SELECT t.`id`,t.`topic` FROM `md_weidashang_topic` t INNER JOIN `md_weidashang_map` m ON m.`wds_topic_id`=t.`id` WHERE m.`product_id`={$wds_id}";
                    $topic_mes = $this->db->query($topic_sql)->row_array();
                    $wds_mes['wds_topic_id'] = $topic_mes['id'];
                    $wds_mes['wds_topic_name'] = $topic_mes['topic'];
                    $status = 'p.`pay_count` DESC,p.`all_amount` DESC,p.`ctime` ASC';
                    $startPage = 0;
                    $pageSize = 1000000;
                    $all_topic_pro = $this->Wds_m->get_topic_list($topic_mes['id'], $status, $startPage, $pageSize); //为了获取活动中全部项目；整理排名
                    for ($n = 0; $n < count($all_topic_pro); $n++) {
                        if ($wds_id == $all_topic_pro[$n]['id']) {
                            $sort = $n + 1;
                        }
                    }
                    $wds_mes['sort'] = $sort;
                }
                $data['wds_mes'] = $wds_mes;
                $this->load->view('weidashang/preview_wds_pro', $data);
            }
        }else{
            echo "<script>alert('提交内容异常，稍后再试！');location.replace('/weidashang/wds_all_pro_list/');</script>";
            return false;
        }
    }
    public function export_wds_all_pro() {
        $arr_title = array(
            "pro_id" => "项目ID",
            "pro_type" => "项目属性",
            "pro_name" => "项目名称",
            "goal" => "目标金额（元）",
            "start_time" => "项目开始时间",
            "end_time" => "项目结束时间",
            "create_user" => "创建人",
            "pay_count" => "参与用户数",
            "all_amount" => "筹资总金额",
        );
        $search_arr["pro_id"] = isset($_POST['pro_id']) ? $_POST['pro_id'] : '';
        $search_arr["pro_name"] = isset($_POST['pro_name']) ? intval($_POST['pro_name']) : '';
        $search_arr["start_time"] = isset($_POST['start_time']) ? $_POST['start_time'] : '';
        $search_arr["end_time"] = isset($_POST['end_time']) ? $_POST['end_time'] : '';
        $search_arr["bysort"] = isset($_POST['bysort']) ? $_POST['bysort'] : 'id';
        $search_arr["byorder"] = isset($_POST['byorder']) ? $_POST['byorder'] : 'DESC';
        $search_arr["time_status"] = isset($_POST['time_status']) ? $_POST['time_status'] : '';
        $search_arr["pro_status"] = isset($_POST['pro_status']) ? $_POST['pro_status'] : '';
        $search_arr["pro_type"] = isset($_POST['pro_type']) ? $_POST['pro_type'] : '';
        $search_arr["money_status"] = isset($_POST['money_status']) ? $_POST['money_status'] : '';

        $result = $this->Wds_acp_m->all_pro_serach($search_arr);
        if (!empty($result)) {
            $export_arr = array();
            for ($i = 0; $i < count($result); $i++) {
                $export_arr[$i]['pro_id'] = $result[$i]['id'];
                if ($result[$i]["type_id"] == 0) {
                    $export_arr[$i]["pro_type"] = "活动项目";
                } elseif ($result[$i]["type_id"] == -1) {
                    $export_arr[$i]["pro_type"] = "独立项目";
                }
                $export_arr[$i]['pro_name'] = $result[$i]['name'];
                $export_arr[$i]["goal"] = $result[$i]["goal"];
                $export_arr[$i]['start_time'] = $result[$i]['start_time'];
                $export_arr[$i]['end_time'] = $result[$i]['end_time'];
                $export_arr[$i]['create_user'] = isset($result[$i]['nickname']) ? $result[$i]['nickname'] : $result[$i]['username'];
                $export_arr[$i]["pay_count"] = $result[$i]["pay_count"];
                $export_arr[$i]["all_amount"] = $result[$i]["all_amount"];
            }
            $path_file = date("Y-m-d H:i:s", time()) . '.xls';
            export_to_excel($arr_title, $export_arr, $path_file, 0);
        } else {
            echo '<script>alert("此次导出操作数据不存在！");location.replace("/weidashang/wds_all_pro_list");</script>';
        }
    }

    /**
     * 微打赏所有订单管理
     */
    public function wds_all_order_list() {
        $data = array();
        $this->load->view('weidashang/wds_all_order_list', $data);
    }

    public function ajax_all_order_list() {
        $res = array();
        $result = array();
        $res = $this->all_order_list_search();

        $result = array(
            'total' => $res["num"],
            'rows' => $res["search"],
            'footer' => '',
        );

        echo json_encode($result);
    }

    public function all_order_list_search() {

        $search_arr["pro_id"] = isset($_POST['pro_id']) ? $_POST['pro_id'] : '';
        $search_arr["pro_name"] = isset($_POST['pro_name']) ? $_POST['pro_name'] : '';
        $search_arr["pay_start_time"] = isset($_POST['pay_start_time']) ? $_POST['pay_start_time'] : '';
        $search_arr["pay_end_time"] = isset($_POST['pay_end_time']) ? $_POST['pay_end_time'] : '';
        $search_arr["pro_type"] = isset($_POST['pro_type']) ? $_POST['pro_type'] : '';
        $search_arr["user_id"] = isset($_POST['user_id']) ? $_POST['user_id'] : '';
        $search_arr["user_name"] = isset($_POST['user_name']) ? $_POST['user_name'] : '';
        $search_arr["user_mobile"] = isset($_POST['user_mobile']) ? $_POST['user_mobile'] : '';
        $search_arr["bak_id"] = isset($_POST['bak_id']) ? $_POST['bak_id'] : '';
        $search_arr["if_pay"] = isset($_POST['if_pay']) ? $_POST['if_pay'] : '';
        $search_arr["pay_platform"] = isset($_POST['pay_platform']) ? $_POST['pay_platform'] : '';
        $search_arr["pay_plan"] = isset($_POST['pay_plan']) ? $_POST['pay_plan'] : '';
        $search_arr["pay_out_num"] = isset($_POST['pay_out_num']) ? $_POST['pay_out_num'] : '';
        $search_arr["pay_status"] = isset($_POST['pay_status']) ? $_POST['pay_status'] : '';

        $search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
        $search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';

        $start = ($search_arr["page"] > 1) ? ($search_arr["page"] - 1) * $search_arr["rows"] : 0;
        $end = ($search_arr["page"] > 1) ? ($search_arr["page"]) * $search_arr["rows"] : $search_arr["rows"];
        //print_r($search_arr);
        $result = $this->Wds_acp_m->all_pro_orders($search_arr);
        $num = $this->Wds_acp_m->all_pro_orders($search_arr, -1);
        //print_r($result);exit;
        $list_info = array();
        if (!empty($result)) {
            foreach ($result as $key => $val) {
                $res["back_id"] = $val["back_id"];
                $res["pay_out_num"] = $val["out_trade_no"];
                $res["pro_id"] = $val["pro_id"];
                $res['pro_name'] = $val['pro_name'];
                $res['pro_start_date'] = $val['pro_start_date'];
                $res['pro_end_date'] = $val['pro_end_date'];
                $res['user_id'] = $val['user_id'];
                $res['user_name'] = isset($val['nickname']) ? $val['nickname'] : $val['username'];
                $res['user_mobile'] = $val['user_mobile'];
                $res['amount'] = $val['amount'];
                $res['pay_plan'] = $val['md_plan'];
                $res['pay_platform'] = $val['pay_platform'];
                $bak_ctime = explode(" ", $val['bak_date']);
                $res['bak_date'] = $bak_ctime[0];
                $res['bak_time'] = $bak_ctime[1];
                switch ($val['if_pay']) {
                    case '0':
                        $res['bak_status'] = '未支付';
                        break;
                    case '1':
                        $res['bak_status'] = '已支付';
                        break;
                    case '2':
                        $res['bak_status'] = '支付失败';
                        break;
                    case '3':
                        $res['bak_status'] = '已退款';
                        break;
                }
                switch ($val['order_status']) {
                    case '100':
                        $res['pay_status'] = '待支付';
                        break;
                    case '102':
                        $res['pay_status'] = '支付待确认';
                        break;
                    case '103':
                        $res['pay_status'] = '支付成功';
                        break;
                    case '104':
                        $res['pay_status'] = '已失效';
                        break;
                    case '105':
                        $res['pay_status'] = '已取消';
                        break;
                    case '106':
                        $res['pay_status'] = '已删除';
                        break;
                    case '403':
                        $res['pay_status'] = '等待退款';
                        break;
                    case '402':
                        $res['pay_status'] = '退款中';
                        break;
                    case '400':
                        $res['pay_status'] = '已退款';
                        break;
                }
                if ($val["pro_type"] == 0) {
                    $res["pro_type"] = "活动项目";
                } elseif ($val["pro_type"] == -1) {
                    $res["pro_type"] = "独立项目";
                }
                $list_info[] = $res;
            }
        }

        $all_orders_info = array();
        $all_orders_info["search"] = $list_info;
        $all_orders_info["num"] = $num;
        return $all_orders_info;
    }

    public function export_wds_order_list() {
        $arr_title = array(
            "back_id" => "摩点订单ID",
            "pay_out_num" => "外部订单号",
            "pro_id" => "项目ID",
            "pro_name" => "项目名称",
            "pro_start_date" => "项目开始时间",
            "pro_end_date" => "项目结束时间",
            "user_id" => "用户ID",
            "user_name" => "用户名称",
            "user_mobile" => "用户手机号",
            "amount" => "订单金额",
            "pay_plan" => "下单渠道",
            "pay_platform" => "支付方式",
            "bak_date" => "支付时间",
            "bak_status" => "支付状态",
            "pro_type" => "项目类别",
        );
        $search_arr["pro_id"] = isset($_POST['pro_id']) ? $_POST['pro_id'] : '';
        $search_arr["pro_name"] = isset($_POST['pro_name']) ? $_POST['pro_name'] : '';
        $search_arr["pay_start_time"] = isset($_POST['pay_start_time']) ? $_POST['pay_start_time'] : '';
        $search_arr["pay_end_time"] = isset($_POST['pay_end_time']) ? $_POST['pay_end_time'] : '';
        $search_arr["pro_type"] = isset($_POST['pro_type']) ? $_POST['pro_type'] : '';
        $search_arr["user_id"] = isset($_POST['user_id']) ? $_POST['user_id'] : '';
        $search_arr["user_name"] = isset($_POST['user_name']) ? $_POST['user_name'] : '';
        $search_arr["user_mobile"] = isset($_POST['user_mobile']) ? $_POST['user_mobile'] : '';
        $search_arr["bak_id"] = isset($_POST['bak_id']) ? $_POST['bak_id'] : '';
        $search_arr["if_pay"] = isset($_POST['if_pay']) ? $_POST['if_pay'] : '';
        $search_arr["pay_platform"] = isset($_POST['pay_platform']) ? $_POST['pay_platform'] : '';
        $search_arr["pay_plan"] = isset($_POST['pay_plan']) ? $_POST['pay_plan'] : '';
        $search_arr["pay_out_num"] = isset($_POST['pay_out_num']) ? $_POST['pay_out_num'] : '';
        $search_arr["pay_status"] = isset($_POST['pay_status']) ? $_POST['pay_status'] : '';

        //print_r($search_arr);
        $result = $this->Wds_acp_m->all_pro_orders($search_arr);
        if (!empty($result)) {
            $export_orders = array();
            for ($i = 0; $i < count($result); $i++) {
                $export_orders[$i]["back_id"] = $result[$i]["back_id"];
                $export_orders[$i]["pay_out_num"] = $result[$i]["out_trade_no"];
                $export_orders[$i]["pro_id"] = $result[$i]["pro_id"];
                $export_orders[$i]['pro_name'] = $result[$i]['pro_name'];
                $export_orders[$i]['pro_start_date'] = $result[$i]['pro_start_date'];
                $export_orders[$i]['pro_end_date'] = $result[$i]['pro_end_date'];
                $export_orders[$i]['user_id'] = $result[$i]['user_id'];
                $export_orders[$i]['user_name'] = isset($result[$i]['nickname']) ? $result[$i]['nickname'] : $result[$i]['username'];
                $export_orders[$i]['user_mobile'] = $result[$i]['user_mobile'];
                $export_orders[$i]['amount'] = $result[$i]['amount'];
                $export_orders[$i]['pay_plan'] = $result[$i]['md_plan'];
                $export_orders[$i]['pay_platform'] = $result[$i]['pay_platform'];
                $export_orders[$i]['bak_date'] = $result[$i]['bak_date'];
                switch ($result[$i]['if_pay']) {
                    case '0':
                        $export_orders[$i]['bak_status'] = '未支付';
                        break;
                    case '1':
                        $export_orders[$i]['bak_status'] = '已支付';
                        break;
                    case '2':
                        $export_orders[$i]['bak_status'] = '支付失败';
                        break;
                    case '3':
                        $export_orders[$i]['bak_status'] = '已退款';
                        break;
                }
                switch ($result[$i]['order_status']) {
                    case '100':
                        $export_orders[$i]['pay_status'] = '待支付';
                        break;
                    case '102':
                        $export_orders[$i]['pay_status'] = '支付待确认';
                        break;
                    case '103':
                        $export_orders[$i]['pay_status'] = '支付成功';
                        break;
                    case '104':
                        $export_orders[$i]['pay_status'] = '已失效';
                        break;
                    case '105':
                        $export_orders[$i]['pay_status'] = '已取消';
                        break;
                    case '106':
                        $export_orders[$i]['pay_status'] = '已删除';
                        break;
                    case '403':
                        $export_orders[$i]['pay_status'] = '等待退款';
                        break;
                    case '402':
                        $export_orders[$i]['pay_status'] = '退款中';
                        break;
                    case '400':
                        $export_orders[$i]['pay_status'] = '已退款';
                        break;
                }
                if ($result[$i]["pro_type"] == 0) {
                    $export_orders[$i]["pro_type"] = "活动项目";
                } elseif ($result[$i]["pro_type"] == -1) {
                    $export_orders[$i]["pro_type"] = "独立项目";
                }
            }
            $path_file = date("Y-m-d H:i:s", time()) . '.xls';
            export_to_excel($arr_title, $export_orders, $path_file, 0);
        } else {
            echo '<script>alert("此次导出操作数据不存在！");location.replace("/weidashang/wds_all_order_list");</script>';
        }
    }

    /**
     * 摩点点项目活动后台
     * Enter description here ...
     */
    public function choudiandian_pro() {
        $data = array();
        $pro_name_arr = $this->Wds_acp_m->get_diandian_pro_name();
        $data['pro_name_arr'] = $pro_name_arr;
        $this->load->view('weidashang/diandian_pro', $data);
    }

    /**
     * 筹点点后台search查询的ajax最终组合方法
     * Enter description here ...
     */
    public function ajax_diandian_pro() {
        $res = array();
        $result = array();
        $res = $this->diandian_pro_search(1);

        $result = array('total' => $res["num"],
            'rows' => $res["search"],
            'footer' => '',
        );

        echo json_encode($result);
    }

    /**
     * 筹点点后台查询详细方法
     * Enter description here ...
     * @param unknown_type $mode
     */
    public function diandian_pro_search($mode = 1) {

        $search_arr["pro_id"] = isset($_POST['pro_id']) ? $_POST['pro_id'] : '';
        $search_arr["pro_name"] = isset($_POST['content_template']) ? intval($_POST['content_template']) : '';
        $search_arr["start_time"] = isset($_POST['start_time']) ? $_POST['start_time'] : '';
        $search_arr["end_time"] = isset($_POST['end_time']) ? $_POST['end_time'] : '';
        $search_arr["sort"] = isset($_POST['bysort']) ? $_POST['bysort'] : 'id';
        $search_arr["order"] = isset($_POST['byorder']) ? $_POST['byorder'] : 'asc';
        $search_arr["type"] = isset($_POST['create_type']) ? $_POST['create_type'] : '';

        if ($mode == 2) {
            $search_arr["page"] = "";
            $search_arr["rows"] = "";
        } else {
            $search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
            $search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';
        }

        $search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
        $search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';

        $start = ($search_arr["page"] > 1) ? ($search_arr["page"] - 1) * $search_arr["rows"] : 0;
        $end = ($search_arr["page"] > 1) ? ($search_arr["page"]) * $search_arr["rows"] : $search_arr["rows"];
        $result = $this->Wds_acp_m->pro_mes_serach($search_arr);
        $num = $this->Wds_acp_m->pro_mes_serach($search_arr, -1);
        //print_r($result);exit;
        $list_info = array();
        if (!empty($result)) {
            foreach ($result as $key => $val) {
                $res["id"] = $val["id"];
                if ($val["type"] == '0') {
                    $res["pro_type"] = "微打赏-活动";
                }
                $res["pro_name"] = $val["topic"];
                if ($val["ctime"] == "0000-00-00 00:00:00") {
                    $res["create_time"] = '';
                } else {
                    $res["create_time"] = $val["ctime"];
                }
                $res["start_time"] = $val["effect_time"];
                $res["end_time"] = $val["end_time"];
                $res["op_user"] = $val["user_name"];
                if ($val["if_show"] == '1') {
                    $res["work"] = '<a href="/weidashang/edit_pro/' . $val["id"] . '" id="edit" class="edit">编辑</a> | <a href="/weidashang/down_pro/' . $val["id"] . '" id="down_pro" class="down_pro" onclick="if(confirm(\'确实要将活动<' . $val["topic"] . '>下线吗？\')) return true;else return false;">下线</a> | <a href="/weidashang/show_pro_sub/' . $val["id"] . '" id="show_sub_pro" class="show_sub_pro">查看参与项目</a>';
                } elseif ($val["if_show"] == '0') {
                    $res["work"] = '<a href="/weidashang/edit_pro/' . $val["id"] . '" id="edit" class="edit">编辑</a> | <a href="/weidashang/go_pro/' . $val["id"] . '" id="go_pro" class="go_pro" onclick="if(confirm(\'确实要将活动<' . $val["topic"] . '>上线吗？\')) return true;else return false;">上线</a> | <a href="/weidashang/show_pro_sub/' . $val["id"] . '" id="show_sub_pro" class="show_sub_pro">查看参与项目</a>';
                }
//                if ($val["if_recommend"] == '1') {
//                    $res["recommend"] = '<a href="/weidashang/abandon_recommend_pro/' . $val["id"] . '" id="abandon_recommend_pro" class="abandon_recommend_pro" onclick="if(confirm(\'确实要放弃推荐<' . $val["topic"] . '>吗？\')) return true;else return false;">放弃推荐</a>';
//                } elseif ($val["if_recommend"] == '0') {
//                    $res["recommend"] = '<a href="/weidashang/recommend_pro/' . $val["id"] . '" id="recommend_pro" class="recommend_pro" onclick="if(confirm(\'确实要推荐<' . $val["topic"] . '>吗？\')) return true;else return false;">推荐轮播</a>';
//                }
                $logo = cdn_url($val["logo"]);
                $res["logo"] = '<img src="' . $logo . '" style="width:80px;height:80px"/>';
                $res["goal"] = $val["goal"];
                $res["active_nums"] = $val["active_nums"];
                $res["all_amount"] = $val["all_amount"];
                $list_info[] = $res;
            }
        }

        $diadian_list_info = array();
        $diadian_list_info["search"] = $list_info;
        $diadian_list_info["num"] = $num;
        return $diadian_list_info;
    }

    /**
     * 筹点点后台创建活动
     * Enter description here ...
     */
    public function create_diandian_pro() {
        $pro_name = isset($_POST["new_pro_name"]) ? $_POST["new_pro_name"] : "";
        $pro_money = isset($_POST["new_pro_money"]) ? $_POST["new_pro_money"] : "";
        $logo = isset($_POST["topic_pic_hidden"]) ? $_POST["topic_pic_hidden"] : "";
        $tag = isset($_POST["new_pro_tag"]) ? $_POST["new_pro_tag"] : "";
        $start_time = isset($_POST["prostart_time"]) ? $_POST["prostart_time"] : "";
        $intro = isset($_POST["new_pro_des"]) ? $_POST["new_pro_des"] : "";
        $des = isset($_POST["pro_con"]) ? $_POST["pro_con"] : "";
        $effect_day = isset($_POST["new_pro_time"]) ? $_POST["new_pro_time"] : "";
        $pro_share_title = isset($_POST["pro_share_title"]) ? $_POST["pro_share_title"] : "";
        $pro_share_des = isset($_POST["pro_share_des"]) ? $_POST["pro_share_des"] : "";
        $user_id = $_SESSION['admin_id'];
        $op_man = $this->md_refund->get_op_name($_SESSION['admin_id']);
        $ctime = date("Y-m-d H:i:s");
        $end_time = date("Y-m-d H:i:s", $effect_day * 24 * 3600 + strtotime($start_time));
        $unit_key = md5($pro_name . '_' . $tag . '_' . $intro);
        $type = 0;
        $if_show = 0;
        $data = array(
            'user_id' => $user_id,
            'user_name' => $op_man,
            'topic' => $pro_name,
            'effect_day' => $effect_day,
            'tag' => $tag,
            'logo' => $logo,
            'intro' => $intro,
            'des' => $des,
            'if_show' => $if_show,
            'unit_key' => $unit_key,
            'type' => $type,
            'ctime' => $ctime,
            'effect_time' => $start_time,
            'end_time' => $end_time,
            'goal' => $pro_money,
            'pro_share_title' => $pro_share_title,
            'pro_share_des' => $pro_share_des
        );

        $if_pro = $this->Wds_acp_m->if_pro($unit_key);
        if (!empty($if_pro)) {
            echo "<script>alert('该活动已经创建过!')</script>";
            return false;
        } else {
            $inner_new_pro = $this->Wds_acp_m->inner_new_pro($data);
            echo "<script>alert('创建成功')</script>";
            return true;
        }
    }

    /**
     * 筹点点后台进入活动编辑更新页面
     * Enter description here ...
     * @param unknown_type $id
     */
    public function edit_pro($id) {
        $data = array();
        $pro_mess = $this->Wds_acp_m->get_edit_pro_mess($id);
        $data['pro_mess'] = $pro_mess;
        $this->load->view('weidashang/diandian_edit_pro', $data);
    }

    /**
     * 筹点点活动更新
     * Enter description here ...
     * @param unknown_type $pro_id
     */
    public function update_diandian_pro($pro_id) {
        $pro_name = isset($_POST["new_pro_name"]) ? $_POST["new_pro_name"] : "";
        $pro_money = isset($_POST["new_pro_money"]) ? $_POST["new_pro_money"] : "";
        $logo = isset($_POST["topic_pic_hidden"]) ? $_POST["topic_pic_hidden"] : "";
        $tag = isset($_POST["new_pro_tag"]) ? $_POST["new_pro_tag"] : "";
        $intro = isset($_POST["new_pro_des"]) ? $_POST["new_pro_des"] : "";
        $des = isset($_POST["pro_con"]) ? $_POST["pro_con"] : "";
        $effect_day = isset($_POST["new_pro_time"]) ? $_POST["new_pro_time"] : "";
        $start_time = isset($_POST["start_time"]) ? $_POST["start_time"] : "";
        $pro_share_title = isset($_POST["pro_share_title"]) ? $_POST["pro_share_title"] : "";
        $pro_share_des = isset($_POST["pro_share_des"]) ? $_POST["pro_share_des"] : "";
        $user_id = $_SESSION['admin_id'];
        //$op_man = $this->md_refund->get_op_name($_SESSION['admin_id']);
        $ctime = date("Y-m-d H:i:s");
        $end_time = date("Y-m-d H:i:s", $effect_day * 24 * 3600 + strtotime($start_time));
        $unit_key = md5($pro_name . '_' . $tag . '_' . $intro);
        $type = 0;
        $data = array(
            'topic' => $pro_name,
            'effect_day' => $effect_day,
            'tag' => $tag,
            'logo' => $logo,
            'intro' => $intro,
            'des' => $des,
            'unit_key' => $unit_key,
            'type' => $type,
            'ctime' => $ctime,
            'end_time' => $end_time,
            'goal' => $pro_money,
            'pro_share_title' => $pro_share_title,
            'pro_share_des' => $pro_share_des
        );
        $update_new_pro = $this->Wds_acp_m->update_pro_mess($pro_id, $data);
        return true;
    }

    /**
     * 筹点点后台-下线活动
     * Enter description here ...
     * @param unknown_type $pro_id
     */
    public function down_pro($pro_id) {
        $down_diandian_pro = $this->Wds_acp_m->down_diandian_pro($pro_id);
        redirect("/weidashang/choudiandian_pro");
        return true;
    }

    /**
     * 筹点点后台-上线活动
     * Enter description here ...
     * @param unknown_type $pro_id
     */
    public function go_pro($pro_id) {
        $topic_mess = $this->Wds_acp_m->get_topic_info($pro_id);
        $go_diandian_pro = $this->Wds_acp_m->go_diandian_pro($pro_id);
        redirect("/weidashang/choudiandian_pro");
        return true;
    }

    /**
     * 筹点点后台查看活动中的项目列表
     * Enter description here ...
     * @param unknown_type $pro_id
     */
    public function show_pro_sub($pro_id) {
        $data = array();
        $topic_mes = $this->Wds_acp_m->get_edit_pro_mess($pro_id);
        $data['topic_mes'] = $topic_mes[0];
        $sub_pro_arr = $this->Wds_acp_m->get_diandian_pro_sub($pro_id);
        for ($i = 0; $i < count($sub_pro_arr); $i++) {
            $pro_cuser = $this->User_m->get_user_info($sub_pro_arr[$i]['user_id']);
            $sub_pro_arr[$i]['sub_pro_cuser'] = $pro_cuser['nickname'];
            $sub_pro_arr[$i]['sub_back_nums'] = $sub_pro_arr[$i]['pay_count'];
            $logo_arr = unserialize($sub_pro_arr[$i]['logo']);
            $sub_pro_arr[$i]['logo'] = $logo_arr[0];
            $sub_pro_arr[$i]['des'] = mb_strimwidth($sub_pro_arr[$i]['des'], 0, 130, '...');
            $sub_pro_arr[$i]['sub_back_moneys'] = $sub_pro_arr[$i]['all_amount'];
        }
        $data['topic_id'] = $pro_id;
        $data['sub_list'] = $sub_pro_arr;

        $this->load->view('weidashang/diandian_sub_list', $data);
    }

    public function get_pro_mess() {
        $productId = isset($_POST['productId']) ? $_POST['productId'] : '';
        $pro_sql = "SELECT * FROM md_weidashang_product WHERE id={$productId}";
        $pro_mess = $this->db->query($pro_sql)->row_array();
        if (!empty($pro_mess)) {
            echo json_encode(array("status" => '1', 'pro_title' => $pro_mess['name'], 'pro_goal' => $pro_mess['goal'], 'start_time' => $pro_mess['start_time'], 'duration' => $pro_mess['duration']));
        } else {
            echo json_encode(array("status" => '0'));
        }
    }

    public function pro_to_topic() {
        $wds_id = isset($_POST["wds_id"]) ? $_POST["wds_id"] : "";
        $wds_name = isset($_POST["wds_name"]) ? $_POST["wds_name"] : "";
        $wds_start_time = isset($_POST["wds_start_time"]) ? $_POST["wds_start_time"] : "";
        $wds_duration = isset($_POST["wds_duration"]) ? $_POST["wds_duration"] : "";
        $wds_goal = isset($_POST["wds_goal"]) ? $_POST["wds_goal"] : "";
        $topic_id = isset($_POST["topic_id"]) ? $_POST["topic_id"] : "";
        $topic_name = isset($_POST["topic_name"]) ? $_POST["topic_name"] : "";
        $topic_start_time = isset($_POST["topic_start_time"]) ? $_POST["topic_start_time"] : "";
        $topic_end_time = isset($_POST["topic_end_time"]) ? $_POST["topic_end_time"] : "";
        $topic_duration = isset($_POST["topic_duration"]) ? $_POST["topic_duration"] : "";
        $wds_end_time = date("Y-m-d H:i:s", $wds_duration * 24 * 3600 + strtotime($wds_start_time));
        if ((strtotime($wds_start_time) < strtotime($topic_start_time)) || (strtotime($wds_end_time) > strtotime($topic_end_time))) {
            echo json_encode(array("status" => '-1'));
        } else {
            $if_have_sql = "SELECT id FROM md_weidashang_map WHERE product_id={$wds_id}";
            $if_have = $this->db->query($if_have_sql)->row_array();
            if (!empty($if_have)) {
                echo json_encode(array("status" => '-2'));
            } else {
                $inner_map = "INSERT INTO `md_weidashang_map` (`wds_topic_id`, `product_id`, `ctime`, `if_show`) VALUES ('{$topic_id}','{$wds_id}','{$wds_start_time}','1') ";
                $this->db->query($inner_map);
                $pro_mes_sql = "SELECT `all_amount`,`pay_count` FROM `md_weidashang_product` WHERE `id` ='{$wds_id}'";
                $pro_mes = $this->db->query($pro_mes_sql)->row_array();
                if (strpos($wds_name, "'") !== false) {
                    $keyword = str_replace("'", "\'", $wds_name);
                }
                $update_pro_sql = "UPDATE `md_weidashang_product` SET `name`='{$wds_name}',`start_time`='{$wds_start_time}',`end_time`='{$wds_end_time}',`type_id`=0,`ctime`='{$wds_start_time}',`duration`={$wds_duration},`goal`={$wds_goal} WHERE id='{$wds_id}'";
                $this->db->query($update_pro_sql);
                $update_topic_sql = "UPDATE `md_weidashang_topic` SET `active_nums`=`active_nums`+{$pro_mes['pay_count']},`all_amount`=`all_amount`+{$pro_mes['all_amount']} WHERE id='{$topic_id}'";
                $this->db->query($update_topic_sql);
                echo json_encode(array("status" => '1', 'wds_name' => $wds_name, 'topic_name' => $topic_name));
            }
        }
    }

    /**
     * 筹点点后台-下线项目
     * Enter description here ...
     * @param unknown_type $pro_id
     * @param unknown_type $sub_id
     */
    public function down_pro_sub($pro_id) {

        $down_diandian_pro = $this->Wds_acp_m->down_diandian_sub($pro_id);
        redirect("/weidashang/wds_all_pro_list");
        return true;
    }

    /**
     * 筹点点后台-上线项目
     * Enter description here ...
     * @param unknown_type $pro_id
     * @param unknown_type $sub_id
     */
    public function updata_pro_sub($pro_id) {

        $up_diandian_pro = $this->Wds_acp_m->updata_diandian_sub($pro_id);
        redirect("/weidashang/wds_all_pro_list");
        return true;
    }

    /**
     * 筹点点后台-放弃选择推荐活动
     * Enter description here ...
     * @param unknown_type $pro_id
     */
    public function abandon_recommend_pro($pro_id) {
        $abandon_pro = $this->Wds_acp_m->abandon_recommend_pro($pro_id);
        redirect("/weidashang/choudiandian_pro");
        return true;
    }

    /**
     * 筹点点后台-选择推荐活动
     * Enter description here ...
     * @param unknown_type $pro_id
     */
    public function recommend_pro($pro_id) {
        $sql = "SELECT count(`id`) as num FROM `md_weidashang_topic` WHERE `if_recommend`=1";
        $count_mes = $this->db->query($sql)->row_array();
        $pro_recount = $count_mes['num'];
        $msql = "SELECT count(`id`) as num FROM `md_weidashang_topic_recom` WHERE `if_recommend`=1";
        $mcount = $this->db->query($msql)->row_array();
        $z_recount = $mcount['num'];
        $all_recount = $pro_recount + $z_recount;
        if ($all_recount < 5) {
            $recommend_pro = $this->Wds_acp_m->recommend_pro($pro_id);
            redirect("/weidashang/choudiandian_pro");
        } else {
            echo "<script>alert('轮播图不能超过5张！');location.replace('/weidashang/choudiandian_pro');</script>";
        }
        return true;
    }

    public function abandon_recommend($id) {
        $abandon = $this->Wds_acp_m->abandon_recommend($id);
        redirect("/weidashang/recom_pic");
        return true;
    }

    public function recommend($id) {
        $sql = "SELECT count(`id`) as num FROM `md_weidashang_topic` WHERE `if_recommend`=1";
        $count_mes = $this->db->query($sql)->row_array();
        $pro_recount = $count_mes['num'];
        $msql = "SELECT count(`id`) as num FROM `md_weidashang_topic_recom` WHERE `if_recommend`=1";
        $mcount = $this->db->query($msql)->row_array();
        $z_recount = $mcount['num'];
        $all_recount = $pro_recount + $z_recount;
        if ($all_recount < 5) {
            $recommend = $this->Wds_acp_m->recommend($id);
            redirect("/weidashang/recom_pic");
        } else {
            echo "<script>alert('轮播图不能超过5张！');location.replace('/weidashang/recom_pic');</script>";
        }
        return true;
    }

    /**
     * 独立项目下线
     * @param type $id
     */
    public function down_inden_pro($id) {

        $down_inden_pro = $this->Wds_acp_m->down_diandian_sub($id);
        redirect("/weidashang/wds_pro_list");
        return true;
    }

    /**
     * 独立项目上线
     * @param type $id
     */
    public function go_inden_pro($id) {
        $up_inden_pro = $this->Wds_acp_m->updata_diandian_sub($id);
        redirect("/weidashang/wds_pro_list");
        return true;
    }

    /**
     * 微打赏-提现管理 
     */
    public function withdraw() {
        $data = array();
        $this->load->view('weidashang/withdraw', $data);
    }

    public function ajax_withdraw_start() {
        $res = array();
        $result = array();
        $res = $this->withdraw_start_search(1);

        $result = array(
            'total' => $res["num"],
            'rows' => $res["search"],
            'footer' => '',
        );
        echo json_encode($result);
    }

    public function withdraw_start_search($mode = 1) {

        $search_arr["wds_id"] = isset($_POST['oid']) ? $_POST['oid'] : '';
        $search_arr["title"] = isset($_POST['topic']) ? intval($_POST['topic']) : '';
        $search_arr["user_id"] = isset($_POST['st_id']) ? $_POST['st_id'] : '';
        $search_arr["st_mobile"] = isset($_POST['st_mobile']) ? $_POST['st_mobile'] : '';
        $search_arr["start_time"] = isset($_POST['play_start_time']) ? $_POST['play_start_time'] : '';
        $search_arr["end_time"] = isset($_POST['play_end_time']) ? $_POST['play_end_time'] : '';
        $search_arr["pro_status"] = isset($_POST['pro_status']) ? $_POST['pro_status'] : '';

        $op_id = $_SESSION['admin_id'];
        $op_man = $this->md_refund->get_op_name($_SESSION['admin_id']);
        if ($mode == 2) {
            $search_arr["page"] = "";
            $search_arr["rows"] = "";
        } else {
            $search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
            $search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';
        }

        $search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
        $search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';

        $start = ($search_arr["page"] > 1) ? ($search_arr["page"] - 1) * $search_arr["rows"] : 0;
        $end = ($search_arr["page"] > 1) ? ($search_arr["page"]) * $search_arr["rows"] : $search_arr["rows"];
        $result = $this->Wds_acp_m->withdraw_mes_serach($search_arr);
        $num = $this->Wds_acp_m->withdraw_mes_serach($search_arr, -1);
        //print_r($result);exit;
        $list_info = array();
        if (!empty($result)) {
            foreach ($result as $key => $val) {
                $res['work'] = '';
                $res['wds_id'] = $val['pro_id'];
                $res['wds_name'] = $val['wds_title'];
                $res['create_user_id'] = $val['user_id'];
                $res['create_user_name'] = isset($val['nickname']) ? $val['nickname'] : $val['username'];
                $res['create_user_mobile'] = $val['user_mobile'];
                $res['wds_start_time'] = $val['start_time'];
                $res['wds_end_time'] = $val['end_time'];
                $res['wds_withdraw_time'] = $val['apply_withdraw_time'];
                $res['goal'] = $val['goal'];
                $res['withdraw_amount'] = $val['funcder_goal'];
                $res['bank_name'] = $val['bank_type'];
                $res['bank_num'] = $val['funder_account_no'];
                $res['receiv_name'] = $val['funder_realname'];
                $res['play_status'] = $val['if_remit'];
                $res['refund_status'] = $val['if_refund'];
                $res['with_status'] = $val['if_withdraw'];
                $res['op_id'] = $op_id;
                $res['op_name'] = $op_man;
                ##提款手续费，按照1%扣除手续费；最低扣除1元手续费
                if ($val['funcder_goal'] <= 100) {
                    $final_total = number_format(round(($val['funcder_goal'] - 1.00), 2),2);
                } else {
                    $final_total = number_format(round($val['funcder_goal'] - ($val['funcder_goal'] * 0.01), 2),2);
                }              
                $single = array(
                    'id' => $val['pro_id'],
                    'receiver' => $val['funder_realname'],
                    'subbank_name' => $val['funder_subbank_name'],
                    'bank_type' => $val['funder_bank_type'],
                    'bank_province' => $val['funder_bank_province'],
                    'bank_city' => $val['funder_bank_city'],
                    'account_no' => $val['funder_account_no'],
                    'recv_mobile' => $val['user_mobile'],
                    'acc_type' => $val['funder_acc_type'],
                    'ali_userid' => $val['ali_userid'],
                    'ali_username' => $val['ali_username'],
                    'total' => $final_total,
                    'remit_way' => $val['pay_platform'],
                );
                //print_r($single);exit;
                if ($val['if_remit'] == '未打款') {
                    $res['work'] = "<a href='#' class='pay-editor' data-pay='" . json_encode($single) . "'>打款</a>";
                }
                if ($val['if_remit'] == '打款失败') {
                    $res['work'] = "<a href='#' class='pay-editor' data-pay='" . json_encode($single) . "'>打款</a>";
                    $sql = "SELECT rlog.callback AS callback FROM md_weidashang_remit_info rlog 
                    WHERE rlog.funder_serial={$val['pro_id']} AND rlog.package_id='{$val['package_id']}' ORDER BY rlog.ctime DESC";
                    $ress = $this->db->query($sql)->row_array();
                    $row['od_status'] = $ress['callback'];
                }

                $sql = "SELECT rchange.user_id AS ruser_id
                                FROM md_weidashang_remit_changes rchange WHERE rchange.pro_id={$val['pro_id']}";
                $mess = $this->db->query($sql)->result_array();
                if (!empty($mess)) {
                    $value = $val['pro_id'];
                    $res['play_detail'] = "<a href='#' class='see-detail' data-see=" . json_encode($value) . ">查看明细</a>";
                }
                $res['back_con'] = "<a href='/weidashang/show_back_mess?pro_id={$val['pro_id']}' class='see-backdetail'>查看订单明细</a>";
                $list_info[] = $res;
            }
        }
        $withdraw_list_info = array();
        $withdraw_list_info["search"] = $list_info;
        $withdraw_list_info["num"] = $num;
        return $withdraw_list_info;
    }

    /**
     * 获取城市列表
     */
    public function ajax_getCityList() {
        $id = isset($_GET['id']) ? intval($this->input->get('id', true)) : '';
        if (empty($id)) {
            echo json_encode(array('status' => '-1', 'data' => ''));
            exit;
        }
        $openning = get_opening_config();
        $city_k = $openning[$id];
        if (empty($city_k)) {
            echo json_encode(array('status' => '-2', 'data' => ''));
            exit;
        }
        $city = get_opening_city_list();
        $str = '';
        foreach ($city_k as $k => $v) {
            $str .= '<option value="' . $v . '">' . $city[$v] . '</option>';
        }
        echo json_encode(array('status' => '0', 'data' => $str));
        exit;
    }

    /**
     * 打款操作
     */
    public function ajax_pay() {        
        $editor_type = $this->input->post('editor_type', true);
        switch (intval($editor_type)) {
            case 1:
                $remit_way = $this->input->post("remit_way", true);               
                if ($remit_way == 1) {
                    $remit_result = $this->remit_caifutong();
                    echo json_encode($remit_result);
                } elseif ($remit_way == 2) {
                    $remit_result = $this->remit_alipay();
                }
                break;
            case 2:
                $password = $this->input->post('all_password', true);
                $where = $this->_get_batchpay_where();
                $data = $this->batch_get_pay($where);
                if (!is_dir("/ROOT/log/php/wds")) {
                    mkdir("/ROOT/log/php/wds", 0755, true);
                }
                error_log(date("Y-m-d H:i:s") . "\t" . var_export($data, true) . "\r\n\r\n", 3, "/ROOT/log/php/wds/weidashang_var.log");
                $res = $this->check_submit_status(1);
                if ($res == false) {
                    echo json_encode(array('msg' => '操作过于频繁请一分钟后再试！', 'pay_type' => 2));
                    exit();
                }
                ob_start($package = $this->md_payment_batch_draw->set_pwd($password)->go($data[0]));
                ob_end_clean();
                $msg = $this->md_weidashang->write_package_log($package, $data);
                if (!empty($msg)) {
                    $data = array('msg' => $msg, 'pay_type' => 2);
                } else {
                    $data = array('msg' => '操作完成', 'pay_type' => 2);
                }
                echo json_encode($data);
                break;
        }
        
    }

    /**
     * 通过财付通打款
     */
    function remit_caifutong() {
        $serial = $this->input->post('serial', true);
        $rec_name = $this->input->post('receiver', true);
        $bank_type = $this->input->post('bank_type', true);
        $area = isset($_POST['area']) ? trim($this->input->post('area', TRUE)) : '0';
        $city = isset($_POST['city']) ? trim($this->input->post('city', TRUE)) : '0';
        $recv_mobile = $this->input->post('recv_mobile', true);
        $rec_bankacc = $this->input->post('account_no', true);
        $subbank_name = $this->input->post('subbank_name', true);
        $pay_amt = $this->input->post('pay_amt', true);
        $password = $this->input->post('password', true);
        $acc_type = $this->input->post("acc_type", true); 
        
        $update_remit_type = "UPDATE `md_weidashang_withdraw` SET `pay_platform`=1  WHERE `pro_id`='{$serial}'";
        $this->db->query($update_remit_type);
        $sql = " SELECT ef.funder_desc AS `desc`
                        FROM md_weidashang_withdraw ef WHERE ef.pro_id='{$serial}'";
        $query = $this->db->query($sql);
        $res = $query->row_array();
        $singledata = array(
            'serial' => $serial,
            'rec_bankacc' => $rec_bankacc,
            'bank_type' => $bank_type,
            'rec_name' => $rec_name,
            'pay_amt' => $pay_amt,
            'acc_type' => $acc_type,
            'area' => $area,
            'city' => $city,
            'subbank_name' => $subbank_name,
            'desc' => $res['desc'],
            'recv_mobile' => $recv_mobile
        );
        //print_r($singledata);exit;
        $content = serialize($singledata);
        $num = array('pay_product_num' => 1,
            'pay_all_amount' => $singledata['pay_amt'],
        );
        $data = array(array($singledata), $num); //准备调用打款接口(单笔)
        $res = $this->check_submit_status(0);
        if ($res == false) {
            echo json_encode(array('msg' => '操作过于频繁请一分钟后再试！', 'pay_type' => 1));
            exit();
        }
        ob_start($package = $this->md_payment_batch_draw->set_pwd($password)->go($data[0]));
        ob_end_clean();
        //var_dump($package);exit;
        $msg = $this->md_weidashang->write_package_log($package, $data);
        if (!empty($msg)) {
            $data = array('msg' => $msg, 'pay_type' => 1);
        } else {
            if (intval($this->input->post('if_change', true)) == 1) {
                $ctime = date("Y-m-d H:i:s", time());
                $change = array('pro_id' => $serial,
                    'content' => $content,
                    'ctime' => $ctime,
                    'user_id' => $_SESSION['admin_id']
                );
                $this->db->insert('md_weidashang_remit_changes', $change);
            }
            $data = array('msg' => '操作完成', 'pay_type' => 1);
        }        
        return $data;
    }

    /**
     * 通过支付宝打款
     */
    function remit_alipay() {
        $serial = $this->input->post('serial', true);
        $pay_amt = $this->input->post('pay_amt', true);
        $password = $this->input->post('password', true);
        $ali_userid = $this->input->post("ali_userid", true);
        $ali_username = $this->input->post("ali_username", true);   
        if($password != _gc('alipay_remit_site_password', 'config')){
            echo "<script>alert('支付宝打款密码错误');location.replace('/weidashang/withdraw');</script>";
            return false;
        }
        $update_remit_type = "UPDATE `md_weidashang_withdraw` SET `pay_platform`=2  WHERE `pro_id`='{$serial}'";
        $this->db->query($update_remit_type);
        $sql = " SELECT ef.funder_desc AS `desc` , `id` as withdarw_id 
                        FROM md_weidashang_withdraw ef WHERE ef.pro_id='{$serial}'";
        $query = $this->db->query($sql);
        $res = $query->row_array();
        $batch_no = date('Ymd') . $serial.date('i') . 'A' . sprintf("%05d", 1);
        $ali_singledata = array(
            'serial' => $serial,          
            'rec_name' => $ali_username,
            'pay_amt' => $pay_amt,
            'ali_userid' => $ali_userid,
            'ali_username' => $ali_username,
            'desc' => $res['desc'],
            'batch_no'=> $batch_no,
        );
        $content = serialize($ali_singledata);
        $num = array('pay_product_num' => 1,
            'pay_all_amount' => $ali_singledata['pay_amt'],
        );
        $data = array(array($ali_singledata), $num); //准备调用打款接口(单笔)
        $res = $this->check_submit_status(0);
        if ($res == false) {
            echo "<script>alert('操作过于频繁请一分钟后再试！');location.replace('/weidashang/withdraw');</script>";
            exit();
        }       
        $this->db->where('pro_id',$serial);
        $this->db->update('md_weidashang_withdraw',array( 'package_id' => $batch_no));               
        $serials[] = $serial;
        $this->Wds_acp_m->set_remit_id($serial)->set_remit_wait($serial);  
        if (intval($this->input->post('if_change', true)) == 1) {
            $ctime = date("Y-m-d H:i:s", time());
            $change = array(
                'pro_id' => $serial,
                'content' => $content,
                'ctime' => $ctime,
                'user_id' => $_SESSION['admin_id']
            );
            $this->db->insert('md_weidashang_remit_changes', $change);
            }
        $package = $this->md_payment_ali_draw->go($data[0]); 
    }

    /**
     * 单笔打款
     * @param type $if_batch 0单笔 1批量
     * @return boolean
     */
    function check_submit_status($if_batch) {
        $time = time();
        switch (intval($if_batch) == 0) {
            case 0:
                $check_submit_file = "check_singlesubmit.log";
                break;
            case 1:
                $check_submit_file = "check_batchsubmit.log";
                break;
            default :
        }
        $limit_time = 30;  //限制时间
        if (file_exists($check_submit_file)) {
            $str = file_get_contents($check_submit_file);
            if ($str > ($time - $limit_time)) {
                return false;
            } else {
                file_put_contents($check_submit_file, $time);
                return true;
            }
        } else {
            file_put_contents($check_submit_file, $time);
            return true;
        }
    }

    /**
     * 获取批量打款的数据信息
     */
    public function ajax_get_pay() {
        $where = $this->_get_batchpay_where();
        $res = $this->batch_get_pay($where);
        echo json_encode($res[1]);
    }

    /**
     * 满足批量打款 搜索的子条件
     * @return type
     */
    public function _get_batchpay_where() {
        $time = time() - 600;
        $time = date("Y-m-d H:i:s", $time);
        return $where = " AND (ef.if_withdraw=1 AND ef.if_remit=0 AND ef.apply_withdraw_time<\"{$time}\" AND ef.funder_account_no!='' AND ef.funder_realname!='' AND ef.funder_bank_type!='' AND ef.funder_bank_city!='' AND ef.funder_bank_province!='' AND ef.funder_subbank_name!='' AND ef.funder_acc_type!='') ORDER BY ef.id LIMIT 10 "; //先测试仅打10个
    }

    /**
     * 批量打款搜索
     * @param type $where
     * @return type
     */
    public function batch_get_pay($where) {//$limit
        $sql = "SELECT ef.pro_id AS serial,
                ef.funder_account_no AS rec_bankacc,
                ef.funder_bank_type AS bank_type,
                ef.funder_realname AS rec_name,
                ef.funder_acc_type AS acc_type,
                ef.funder_bank_province AS area,
                ef.funder_bank_city AS city,
                ef.funder_subbank_name AS subbank_name,
                ef.funder_desc AS `desc`,
                ef.funder_recv_mobile AS recv_mobile
    FROM md_weidashang_withdraw ef WHERE 1 {$where} "; //{$limit}
        if (!is_dir("/ROOT/log/php/wds")) {
            mkdir("/ROOT/log/php/wds", 0755, true);
        }
        error_log(date("Y-m-d H:i:s") . "\t" . var_export($sql, true) . "\r\n\r\n", 3, "/ROOT/log/php/wds/weidashang_withdraw_sql.log");
        $query = $this->db->query($sql);
        $rows = $query->result_array($query);
        $pay_user_num = 0;
        $pay_all_amount = 0.0;
        foreach ($rows as $key => &$row) {
            $sql = "SELECT p.all_amount AS total
            FROM md_weidashang_product p WHERE p.id='{$row['serial']}'";
            $query = $this->db->query($sql);
            $res = $query->row_array();
            $row['pay_amt'] = round($res['total'] - ( $res['total'] * 0.02 + 1 ), 2); //收取手续费后的最终打款金额
            if ($row['pay_amt'] <= 0 || $row['pay_amt'] == "") {
                unset($rows[$key]);
            }
            $pay_all_amount += $row['pay_amt'];
        }
        $pay_product_num = count($rows);
        $pay_user_num = $pay_product_num;
        $data = array('pay_product_num' => $pay_product_num,
            'pay_user_num' => $pay_user_num,
            'pay_all_amount' => $pay_all_amount,
        );
        return array($rows, $data);
    }

    /**
     * 获取打款明细
     */
    public function ajax_get_change_detail() {
        $id = isset($_GET['id']) ? intval($this->input->get('id', true)) : "";
        $sql = "SELECT rchange.pro_id AS serial,
                rchange.content AS content,
                rchange.ctime AS ctime,
                rchange.user_id AS user_id
            FROM md_weidashang_remit_changes rchange WHERE rchange.pro_id={$id}";
        $res = $this->db->query($sql)->result_array();
        $str = '';
        foreach ($res as &$row) {
            $row['content'] = unserialize($row['content']);
            $msg = '收款帐号:' . $row['content']['rec_bankacc'] . ',银行编码:' . $row['content']['bank_type'] . ',收款人姓名:' . $row['content']['rec_name'] . ',帐号类型:' . $row['content']['acc_type'] . ',省编码:' . $row['content']['area'] . ',城市编码:' . $row['content']['city'] . ',支行名称:' . $row['content']['subbank_name'] . ',收款手机号:' . $row['content']['recv_mobile'];
            $str .= '<tr class="each-detail"><td>' . $row['serial'] . '</td>' . '<td>' . $row['ctime'] . '</td>' . '<td>' . $row['user_id'] . '</td>' . '<td>' . $msg . '</td></tr>';
        }
        echo $str;
    }

    /**
     * 提现 同步
     */
    public function syn_status() {
        $syn_password = $this->input->post('syn_pwd', true); //准备调用查询接口
        $package_ids = $this->md_weidashang->get_wait_remit_package();
        $error = '';
        foreach ($package_ids as $row) {
            $res = $this->md_payment_batch_draw->set_pwd($syn_password)->query($row['package_id']);
            if (isset($res['error']) && !empty($res['error'])) {
                $data = array('status' => '-1', 'msg' => "包id:" . $row['package_id'] . ":" . $res['error']);
                $error .= "包id:" . $row['package_id'] . ":" . $res['error'];
//                echo json_encode($data);
//                exit;
            }
            $this->md_weidashang->write_syn_info($res, $row['package_id']);
        }
        $data = array('status' => '0', 'msg' => '操作完成' . $error);
        echo json_encode($data);
    }

    /**
     * 导出提现excel
     */
    public function export_withdraw() {
        $arr_title = array(
            "pro_id" => "项目ID",
            "wds_title" => "项目名称【项目ID】",
            "user_id" => "申请人ID",
            "nickname" => "申请人名称",
            "user_mobile" => "预留手机号",
            "start_time" => "项目开始时间",
            "end_time" => "项目结束时间",
            "apply_withdraw_time" => "提现申请时间",
            "goal" => "目标金额",
            "funcder_goal" => "实际提现金额",
            "bank_type" => "收款银行",
            "funder_account_no" => "收款账号",
            "funder_realname" => "收款人",
            "if_remit" => "打款状态",
            "if_refund" => "退款状态",
            "if_withdraw" => "申请状态",
        );

        $search_arr["wds_id"] = isset($_POST['oid']) ? $_POST['oid'] : '';
        $search_arr["title"] = isset($_POST['topic']) ? $_POST['topic'] : '';
        $search_arr["user_id"] = isset($_POST['st_id']) ? $_POST['st_id'] : '';
        $search_arr["st_mobile"] = isset($_POST['st_mobile']) ? $_POST['st_mobile'] : '';
        $search_arr["start_time"] = isset($_POST['play_start_time']) ? $_POST['play_start_time'] : '';
        $search_arr["end_time"] = isset($_POST['play_end_time']) ? $_POST['play_end_time'] : '';
        $search_arr["pro_status"] = isset($_POST['pro_status']) ? $_POST['pro_status'] : '';
//		$search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
//		$search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';
        $result = $this->Wds_acp_m->withdraw_mes_serach($search_arr);
        for ($i = 0; $i < count($result); $i++) {
            $result[$i]['wds_title'] = $result[$i]['wds_title'] . '【' . $result[$i]['pro_id'] . '】';
        }
        $path_file = date("Y-m-d H:i:s", time()) . '.xls';
        export_to_excel($arr_title, $result, $path_file, 0);
    }

    /**
     * 某一个体现项目的订单明细
     */
    public function show_back_mess() {
        $pro_id = $_GET['pro_id'];
        $data = array();
        $data['wds_id'] = $pro_id;
        $back_sql = "SELECT b.ctime,b.amount ,u.id,u.nickname,u.username,p.all_amount,p.name,p.start_time,p.end_time FROM `md_product_back` b ";
        $back_sql .= "LEFT JOIN `md_users` u ON b.user_id=u.id ";
        $back_sql .= "LEFT JOIN `md_weidashang_product` p ON b.wds_id=p.id WHERE b.if_pay=1 AND b.wds_id={$pro_id} order by b.ctime DESC";
        $back_mess = $this->db->query($back_sql)->result_array();
        $real_all = "SELECT sum(amount) as all_ramount FROM `md_product_back` WHERE if_pay=1 AND wds_id={$pro_id}";
        $real_mes = $this->db->query($real_all)->row_array();
        $data['back_mess'] = $back_mess;
        $data['real_mess'] = $real_mes;
        $this->load->view('weidashang/back_mess', $data);
    }

    /**
     * 退款管理
     */
    function refund() {
        $data = array();
        $data['failure_pro_lsts'] = $this->md_refund->get_refund_failure_wds_lsts();
        $data['type'] = "众筹失败批退";
        $result['lst_type'] = 1;
        $this->load->view('weidashang/refund', $data);
    }

    public function ajax_refund() {
        $page = isset($_POST['page']) ? intval($_POST['page']) : 1;
        $rows = isset($_POST['rows']) ? intval($_POST['rows']) : 20;
        $pro_id = isset($_POST['pro_id']) ? intval($_POST['pro_id']) : 0;
        $lst_type = isset($_POST['lst_type']) ? intval($_POST['lst_type']) : 1;

        $refund_lsts = array();
        $total_refund = 0;
        $total_amount = 0;
        if ($pro_id != 0) {
            switch ($lst_type) {
                case 1:
                    $res = $this->md_refund->get_wds_refund_lsts_info($pro_id);
                    $refund_lsts = $res['lsts'];
                    $total_amount = $res['tamount'];
                    $total_refund = $res['total'];
                    break;
                default:
                    # code...
                    break;
            }

            $per_page = $rows;
            $offset = ($page - 1) * $per_page;
            $refund_lsts = array_slice($refund_lsts, $offset, $per_page);
        }

        $footer = array(array('pay_out_trade_no' => "退款总笔数",
                'trade_no' => $total_refund,
            ),
            array('pay_out_trade_no' => "退款总金额",
                'trade_no' => $total_amount,
            ),
        );
        $result['footer'] = $footer;
        $result['total'] = $total_refund;
        $result['rows'] = $refund_lsts;
        $result['lst_type'] = $lst_type;

        echo json_encode($result);
    }

    // 导出excel
    function export_wds_order() {
        $pro_id = isset($_POST['pro_id']) ? intval($_POST['pro_id']) : 0;
        if ($pro_id == 0) {
            err_exit('pro_id illegal', __FILE__, __FUNCTION__, __LINE__);
        }

        $data = $this->md_refund->get_backup_wds_order_lsts($pro_id);
        $filename = $pro_id . '_项目批退订单_' . date('YmdHis') . '.xls';
        $this->md_refund->export_ord($data, $filename, 0);
    }

    function refund_info() {
        $data = array();
        $data['type'] = '退款结果明细';
        $this->load->view('weidashang/refund_info', $data);
    }

    function load_refund_ord_info() {
        $page = isset($_POST['page']) ? intval($_POST['page']) : 1;
        $rows = isset($_POST['rows']) ? intval($_POST['rows']) : 20;

        $refund_ord = $this->md_refund->get_wds_refund_order_info();

        $result['total'] = count($refund_ord);      // 总退单数
        $result['t_req_m'] = 0;                     // 总请求金额
        $result['t_ntf_m'] = 0;                     // 总退款金额
        $result['t_t'] = 0;                         // 今日退单数
        $result['t_t_req_m'] = 0;                   // 今日总请求金额
        $result['t_t_ntf_m'] = 0;                   // 今日总退款金额
        $nowdays = date("Y-m-d 00:00:00");
        $nowdaye = date("Y-m-d 23:59:59");
        foreach ($refund_ord as $i => $v) {
            if ($nowdays <= $v['refund_date'] && $v['refund_date'] <= $nowdaye) {
                ++$result['t_t'];
                $result['t_t_req_m'] += $v['refund_amount'];
                $result['t_t_ntf_m'] += $v['ntf_amount'];
            }
            $result['t_req_m'] += $v['refund_amount'];
            $result['t_ntf_m'] += $v['ntf_amount'];
        }

        $per_page = $rows;
        $offset = ($page - 1) * $per_page;
        $result['rows'] = array_slice($refund_ord, $offset, $per_page);

        echo json_encode($result);
    }

    public function ajax_batch_refund() {
        $pro_id = isset($_POST['pro_id']) ? $_POST['pro_id'] : 0;
        if (empty($pro_id) || $pro_id == 0) {
            err_exit('pro_id illegal', __FILE__, __FUNCTION__, __LINE__);
        }
        $pro_status = $this->md_refund->get_wds_fnc_status($pro_id);
        if ($pro_status != '众筹失败') {
            err_exit('pro_id illegal', __FILE__, __FUNCTION__, __LINE__);
        }

        // 退款前，服务器端保存该项目的所有订单明细
        $path = config_item('uploads_path') . 'refund_wds_back_file/';
        $filename = $pro_id . '_项目退款订单明细_' . '退款前_' . date('YmdHis') . '.csv';
        $filename = $path . $filename;
        $data = $this->md_refund->get_backup_wds_order_lsts($pro_id);

        // 对待退款订单退款
        $this->_refund_account($pro_id);

        // 待支付订单状态变为已失效
        $this->_update_unpay_order_status($pro_id);
        //exit('12345');
        // 跳转到新页面
        redirect('/weidashang/refund');
    }

    function _refund_account($pro_id) {
        $res = $this->md_refund->get_wds_refund_lsts_info($pro_id); //获取退款列表
        if (!empty($res)) {
            $refund_lsts = $res['lsts'];
            $this->_cache_refund_lsts($refund_lsts); //缓存退款列表内容
            $payways = array('alipay_wap', 'weixin_wap', 'alipay_app', 'weixin_app');
            foreach ($payways as $way) {
                $batch = 0;
                ##获取内容缓存；不为空的执行退款操作
                while ($lsts = $this->_filter_payway_lsts($way, ++$batch)) {
                    switch ($way) {
                        case 'alipay_wap':
                            $this->_refund_alipay_account($pro_id, $lsts); //支付宝退款
                            break;
                        case 'alipay_app':
                            $this->_refund_alipay_account($pro_id, $lsts); //支付宝退款
                            break;
                        case 'weixin_wap':
                            $this->_refund_weixinpay_account($pro_id, $lsts); //微信退款
                            break;
                        case 'weixin_app':
                            $this->_refund_weixinpay_app_account($pro_id, $lsts); //APP微信退款
                            break;
                        default:
                            # code...
                            break;
                    }
                }
            }
        }
    }

    // 待支付订单状态变为已失效
    function _update_unpay_order_status($pro_id) {
        $olsts = $this->md_refund->get_wds_unpay_order_lsts($pro_id);
        foreach ($olsts as $row) {
            $this->Order_biz->set_oid($row['back_id'])->update_status('104');
        }
    }

    // 众筹失败阿里批退退款接口
    function _refund_alipay_account($pro_id, $lsts) {
        $op_man = $this->md_refund->get_op_name($_SESSION['admin_id']);
        $refund_ord_info = array();
        $batch_amount = 0;
        $batch_id = $this->md_refund->get_wds_next_batch_id($pro_id);
        $batch_no = $this->md_refund->create_next_batch_no($pro_id, $batch_id, 'A');
        $refund_date = date("Y-m-d H:i:s");
        $batch_num = 0;
        $detail_data = "";
        foreach ($lsts as $v) {
            ++$batch_num;
            $detail_data .= "{$v['trade_no']}^{$v['refund_amount']}^{$v['refund_rsn']}#";

            $batch_amount += $v['refund_amount'];
            $refund_ord_info[] = array('batch_no' => "$batch_no",
                'back_id' => "{$v['back_id']}",
                'pay_out_trade_no' => "{$v['pay_out_trade_no']}",
                'trade_no' => "{$v['trade_no']}",
                'refund_amount' => "{$v['refund_amount']}",
                'refund_rsn' => "{$v['refund_rsn']}",
                'refund_date' => "$refund_date",
                'user_realname' => "{$v['user_realname']}",
                'user_reg_mobile' => "{$v['user_reg_mobile']}",
                'op_type' => 1,
                'op_reason' => "",
                'op_time' => "",
                'op_man' => "{$op_man}", // 文案??????
            );
        }
        $detail_data = rtrim($detail_data, '#');

        // 退款
        $parm['batch_no'] = $batch_no;
        $parm['refund_date'] = $refund_date;
        $parm['batch_num'] = $batch_num;
        $parm['detail_data'] = $detail_data;
        $alipayapi_return = $this->md_refund->refund_alipayapi($parm);

        $req_status = $this->md_refund->get_refund_req_status($alipayapi_return['return_code']);
        switch ($req_status) {
            case '请求成功': // 更新状态：退款中
                foreach ($refund_ord_info as $key => $ord_info) {
                    $this->Order_biz->set_oid($ord_info['back_id'])->update_status('402');
                }
                break;
            case '请求失败': // 转入线下人工退款流程
                foreach ($refund_ord_info as $key => $ord_info) {
                    $refund_ord_info["$key"]['op_type'] = 11;
                    $refund_ord_info["$key"]['op_reason'] = '支付宝退款请求失败';
                    $refund_ord_info["$key"]['op_time'] = date("Y-m-d H:i:s");
                }
                break;
            default:
                # code...
                break;
        }

        // 保存退款信息到数据库
        $req_info = array('0' => $alipayapi_return + array('pro_id' => intval(30000000 + $pro_id), 'batch_id' => $batch_id, 'batch_amount' => $batch_amount));
        $this->md_refund->save_wds_refund_req_log($req_info);
        $this->md_refund->save_wds_refund_order_info($refund_ord_info);
    }

    // weixin 退款
    function _refund_weixinpay_account($pro_id, $lsts) {

        foreach ($lsts as $ii => $row) {
            $err_msg = null;
            $is_app = in_array($row['back_plan'], array('android', 'ios')) ? true : false;
            if ($this->md_payment_weixin->refund($row['pay_out_trade_no'], $row['pay_amount'], $err_msg, $is_app) == true) {
                $this->Order_biz->set_oid($row['back_id'])->update_status('400');
            } else {
                // var_dump($err_msg);
            }
            $log_path = '/tmp/' . date('Y-m-d') . '-wdserr-weixin-refund.log';
            error_log(json_encode($err_msg) . PHP_EOL, 3, $log_path);
        }
    }

    // APP 
    // weixin 退款
    function _refund_weixinpay_app_account($pro_id, $lsts) {
        foreach ($lsts as $ii => $row) {
            $is_app = $row['back_plan'];
            //print_r($row);exit;
            $inputObj = array();
            $inputObj['out_trade_no'] = $row['pay_out_trade_no'];
            $inputObj['out_refund_no'] = $row['pay_out_trade_no'];
            $inputObj['total_fee'] = $row['pay_amount'] * 100;
            $inputObj['refund_fee'] = $row['refund_amount'] * 100;
            if ($this->md_payment_weixin->wds_app_wx_refund($inputObj, 30, $is_app) == true) {
                $this->Order_biz->set_oid($row['back_id'])->update_status('400');
            } else {
                // var_dump($err_msg);
            }
        }
    }

    /**
     * 批退请求记录
     */
    function batch_log() {
        $data['type'] = '退款请求记录';
        $this->load->view("weidashang/wds_batch_log", $data);
    }

    function load_batch_log() {
        $page = isset($_POST['page']) ? intval($_POST['page']) : 1;
        $rows = isset($_POST['rows']) ? intval($_POST['rows']) : 20;

        $batch_log = $this->md_refund->get_wds_refund_req_log();
        $result['total'] = count($batch_log);

        $result['success'] = 0;
        $result['failure'] = 0;
        foreach ($batch_log as $i => $v) {  // 后期改善：加一列状态字段
            $req_status = $this->md_refund->get_wds_refund_req_status($v['return_code']);
            switch ($req_status) {
                case '请求成功':
                    ++$result['success'];
                    break;
                case '请求失败':
                    ++$result['failure'];
                    break;
                default:
                    # code...
                    break;
            }
        }

        $per_page = $rows;
        $offset = ($page - 1) * $per_page;
        $result['rows'] = array_slice($batch_log, $offset, $per_page);

        echo json_encode($result);
    }

    // 根据支付类型，获取每个批次的退款订单
    function _filter_payway_lsts($way, $batch) {
        $per_batch = 0;
        $offset = 0;
        switch ($way) {
            case 'alipay_wap':
                $per_batch = 999;   // 每个退款批次的退款单数，调试时可设置为相应的值
                $offset = ($batch - 1) * $per_batch;
                $refund_lsts = $this->_get_cached_alipay_lsts();
                break;
            case 'weixin_wap':
                $per_batch = 100;   // 每个退款批次的退款单数，调试时可设置为相应的值
                $offset = ($batch - 1) * $per_batch;
                $refund_lsts = $this->_get_cached_weixinpay_lsts();
                break;
            case 'weixin_app':
                $per_batch = 100;   // 每个退款批次的退款单数，调试时可设置为相应的值
                $offset = ($batch - 1) * $per_batch;
                $refund_lsts = $this->_get_cached_weixinpay_app_lsts();
                break;
            default:
                $refund_lsts = array();
                break;
        }
        return array_slice($refund_lsts, $offset, $per_batch);
    }

    // 缓存数据
    static function _cache_refund_lsts($refund_lsts) {
        $cache_key = sprintf('%s', "refundlsts4filurepro");
        if (md_memcache::get($cache_key))
            md_memcache::delete($cache_key);
        md_memcache::set($cache_key, $refund_lsts, 43200);

        $alipay_lsts = array_filter($refund_lsts, "self::_is_alipay_wap");
        $cache_key = sprintf('%s', "refundlsts4alipay");
        if (md_memcache::get($cache_key))
            md_memcache::delete($cache_key);
        md_memcache::set($cache_key, $alipay_lsts, 43200);

        $data = md_memcache::get($cache_key);

        $weixinpay_lsts = array_filter($refund_lsts, "self::_is_weixinpay_wap");
        $cache_key = sprintf('%s', "refundlsts4weixinpay");
        if (md_memcache::get($cache_key))
            md_memcache::delete($cache_key);
        md_memcache::set($cache_key, $weixinpay_lsts, 43200);

        $weixinpay_app_lsts = array_filter($refund_lsts, "self::_is_weixinpay_app");
        $cache_key = sprintf('%s', "refundlsts4weixinpayapp");
        if (md_memcache::get($cache_key))
            md_memcache::delete($cache_key);
        md_memcache::set($cache_key, $weixinpay_app_lsts, 43200);
    }

    static function _get_cached_refund_lsts() {
        $cache_key = sprintf('%s', "refundlsts4filurepro");
        if (md_memcache::get($cache_key))
            return md_memcache::get($cache_key);
        return array();
    }

    static function _get_cached_alipay_lsts() {
        $cache_key = sprintf('%s', "refundlsts4alipay");
        if (md_memcache::get($cache_key))
            return md_memcache::get($cache_key);
        return array();
    }

    static function _get_cached_weixinpay_lsts() {
        $cache_key = sprintf('%s', "refundlsts4weixinpay");
        if (md_memcache::get($cache_key))
            return md_memcache::get($cache_key);
        return array();
    }

    static function _get_cached_weixinpay_app_lsts() {
        $cache_key = sprintf('%s', "refundlsts4weixinpayapp");
        if (md_memcache::get($cache_key))
            return md_memcache::get($cache_key);
        return array();
    }

    static function _is_alipay_wap($v) {
        if ($v['pay_platform'] == 'alipay_wap') {
            return true;
        } else {
            return false;
        }
    }

    static function _is_weixinpay_wap($v) {
        if ($v['pay_platform'] == 'weixin_wap') {
            return true;
        } else {
            return false;
        }
    }

    static function _is_weixinpay_app($v) {
        if ($v['pay_platform'] == 'weixin_app') {
            return true;
        } else {
            return false;
        }
    }

}
