<?php $this->load->view('ckad/header') ?>
<link href='<?= static_url(); ?>css/bootstrap-datetimepicker.min.css' rel='stylesheet' />
<link href='<?= static_url(); ?>css/blue/style.css' rel='stylesheet'>
<script src="<?= static_url(); ?>js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
<script src="<?= static_url(); ?>js/bootstrap-datetimepicker.zh-CN.js" type="text/javascript"></script>
<script type="text/javascript" src="<?= static_url(); ?>js/bootstrap.min.js"></script>
<script type="text/javascript" src="<?= static_url(); ?>js/jquery.tablesorter.min.js"></script>
<script type="text/javascript" src="<?= base_url(); ?>static/js/ajaxfileupload.js"></script>
<script type="text/javascript">
    $(function() {
        $('#datetimepicker').datetimepicker({
            language: 'zh-CN',
            pickTime: false
        }).attr('readonly', 'readonly');

        $('#user_status .datetimepicker2').datetimepicker({
            language: 'zh-CN',
            pickTime: false
        }).attr('readonly', 'readonly');
    });
</script>
<style type="text/css">
 .wechat_jy{width: 224px;border-radius: 10px;border: 1px solid #ccc;padding: 0 8px;position: relative;font-size: 14px;background: #fff;}
    .wechat_jy>div:first-child{height: 10px;background: #ab7c72;border-top-left-radius: 9px;border-top-right-radius: 9px;position: absolute;top: 0;left: 0;width: 100%;}
    p{line-height: 16px;}
    .wechat_bold{font-weight: bold;margin-top: 25px;font-size: 16px;}
    .wechat_p{font-size: 14px;color: #888;line-height: 8px;}
    
    .black_overlay{  
        display: none;  
        position: absolute;  
        top: 0%;  
        left: 0%;  
        width: 100%;  
        height: 2000px;  
        background-color: black;  
        z-index:1001;  
        -moz-opacity: 0.8;  
        opacity:.80;  
        filter: alpha(opacity=80);  
    }  
    .white_content {  
        display: none;  
        position: absolute;  
        top: 25%;  
        left: 25%;  
        width: 50%;  
        height: 0 auto;  
        padding: 16px;  
        border: 2px solid rgba(68, 218, 224, 0.5);  
        background-color: white;  
        z-index:1002;  
    }
</style>
<div>
    <ul class="breadcrumb">
        <li>
            <a href="#">首页</a> <span class="divider">/</span>
        </li>
        <li>
            <a href="/weixin_manage/weixin_spread">微信应用管理</a>
        </li>
    </ul>
</div>
<div class="row-fluid sortable">
    <div class="box span12">
        <form class="forms addform" name="addform" id="addform" action="" method="post">
            <div role="tablist" id="pro_tab" class="nav nav-tabs btn-group">
                <input class="btn btn-default first_slider active" type="button" value="第一步：选择用户范围" style="width:240px;"/>
                <input class="btn btn-default second_slider" type="button" value="第二步：选择模版" style="width:240px"/>
                <input class="btn btn-default third_slider" type="button" value="第三步：编辑内容" style="width:240px"/>
                <input class="btn btn-default forth_slider" type="button" value="第四步：预览发布" style="width:240px"/>
            </div>        	
            <div id="p1" class="easyui-panel" title="创建推广" style="height:0 auto;padding:10px;margin: 0;;position:relative" data-options="collapsible:true">
                <div id="first_step" style="display:block;">
                    <input type="hidden" value="" id="sel_user_status_id"/>
                    <table>
                        <tr>
                            <th>
                                <span style="font-size:20px;margin-left:20px">选择用户范围</span>							
                            </th>
                            <th>
                                <span style="font-size:16px;margin-left:130px">用户组名称</span>
                            </th>
                            <th>
                                <span style="font-size:16px;margin-left:130px">筛选范围</span>							
                            </th>
                            <th>
                                <span style="font-size:16px;margin-left:130px">用户数</span>							
                            </th>

                        </tr>
                        <tr>
                            <td>
                                <div style="border:solid 1px #000;width:150px;height:150px;margin-top:10px;text-align:center">
                                    <div style="width:80px;height:80px;margin:40px">
                                        <span style="font-size:14px">排重用户数</span><br/>
                                        <span style="font-size:14px"><?php echo $user_count; ?> + <?php echo $fans_count; ?></span><br>                                      
                                    </div>
                                    <span style="font-size:14px">(用户数：摩点总用户数 + 只关粉为成为用户数)</span>
                                </div>
                            </td>							
                            <td>
                                <div style="margin-left:100px;" id="user_arr_sel">
                                    <?php foreach ($user_status as $users) { ?>

                                        <span>
                                            <input type="radio"  name="user_arr" class="checkbox" value="<?php echo $users['id'] ?>" status_deals="<?php echo $users['status_deals'] ?>">
                                            <?php echo $users['status_name'] ?>
                                        </span>
                                        <br/>
                                    <?php } ?>							

                                </div>
                                <a href="javascript:;" id="create_user" class="create_user" style="margin-left:100px;">新建用户组</a>
                            </td>
                            <td>
                                <div style="margin-left:100px;margin-top:-25px;">
                                    <?php foreach ($user_status as $users) { ?>
                                        <span><?php echo $users['status_deals'] ?></span>
                                        <br/>
                                    <?php } ?>

                                </div>							
                            </td>
                            <td>
                                <div style="margin-left:100px;margin-top:-25px;" class="users_nums">
                                    <?php foreach ($user_status as $users) { ?>
                                        <span class="ths_users">
                                            <?php echo $users['users_count']; ?>

                                            <a href="javascript:;" class="ajax_user"  style="margin-left:20px;" status_id="<?php echo $users['id'] ?>">刷新用户</a>									
                                        </span>
                                        <br/>
                                    <?php } ?>

                                </div>															
                            </td>
                        </tr>
                    </table>
                    <div class="span1" style="margin:60px">                 
                        <a id="submit_next_1" class="btn btn-primary" href="javascript:;" style="width:150px">下一步</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><br>
                    </div>                                                          
                </div>
                <div id="second_step" style="display:none;">
                    <div  class="edit_pro">
                        <div class="row-fluid">
                            <div class="input-prepend input-append">
                                <span class="add-on">推广标题:</span>
                                <input style="margin-left:20px;" type="text" id='new_spread_title' name='new_spread_title' value="" placeholder="推广标题，字数限制 15 个字"/>
                            </div>
                        </div>						
                    </div>
                    <div  class="edit_pro">
                        <div class="row-fluid">
                            <div class="input-prepend input-append">
                                <span class="add-on">选择模板:</span>
                                <div class="template_select" style="margin-left:85px">
                                    <label class="radio inline">
                                        <input type="radio" name="template_select" value="10" checked="checked" wx_tpl_name="众筹项目启动通知"/>众筹项目启动通知
                                    </label><br/>
                                    <label class="radio inline">
                                        <input type="radio" name="template_select" value="13" wx_tpl_name="账号未绑定通知"/>账号未绑定通知
                                    </label>                                  
                                </div>
                            </div>
                        </div>						
                    </div>
                    <div class="span1">                 
                        <a id="submit_next_2" class="btn btn-primary" href="javascript:;" style="width:150px">下一步</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><br>
                    </div>
                    <div style="margin-top:100px">
                        <p style="color:red;font-size:18px">强调声明：</p>
                        <ol>
                            <li>逐步填写之前请先确定第三步中用户群筛选条件</li>
                            <li>如果缺少请先进行新增用户群操作；</li>
                            <li>如果选择了“账号未绑定通知”模板，用户群体请唯一限定选择第一个</li>
                        </ol>
                    </div>                                  											
                </div>	
                <div id="third_step" style="display:none;"> 
                    <div id="temeplate_1" style="display:none;">
                        <div  class="edit_pro">
                            <div class="row-fluid">
                                <div class="input-prepend input-append">
                                    <span class="add-on">项目ID:</span>
                                    <input style="margin-left:20px;" type="text" id='pro_id' name='pro_id' value="" placeholder="项目ID"/>
                                    <button class="btn btn-primary" id="topic_up" name="topic_up" type="button">确定</button>                                  
                                </div>
                            </div>
                            <hr>
                            <div class="row-fluid">
                                <div class="input-prepend input-append">
                                    <span class="add-on">FirstData:</span>
                                    <input style="margin-left:20px;" type="text" id='second_data' name='second_data' value="" placeholder="推送标题；不超过15个字"/>
                                </div>
                            </div>						
                            <div class="row-fluid">
                                <div class="input-prepend input-append">
                                    <span class="add-on">项目名称:</span>
                                    <input style="margin-left:20px;" type="text" id='pro_name' name='pro_name' value="" />
                                </div>
                            </div>						
                            <div class="row-fluid">
                                <div class="input-prepend input-append">
                                    <span class="add-on">目标金额:</span>
                                    <input style="margin-left:20px;" type="text" id='pro_goal' name='pro_goal' value="" readOnly="true" />
                                </div>
                            </div>						
                            <div class="row-fluid">
                                <div class="input-prepend input-append">
                                    <span class="add-on">结束时间:</span>
                                    <input style="margin-left:20px;" type="text" id='pro_end_time' name='pro_end_time' value="" readOnly="true"/>
                                </div>
                            </div>						
                            <div class="row-fluid">
                                <div class="input-prepend input-append">
                                    <span class="add-on">项目简介:</span>
                                    <input type="hidden" id="content_text" name="content_text" value="" style="display:none;"/>
                                    <textarea style="margin-left:20px;" id="text" name="text"></textarea>
                                </div>
                            </div>						
                            <div class="row-fluid">
                                <div class="input-prepend input-append">
                                    <span class="add-on">Remark:</span>
                                    <input style="margin-left:20px;" type="text" id='second_remark' name='second_remark' value="" placeholder="推送footer；不超过12个字"/>
                                </div>
                            </div>						
                            <div class="row-fluid">
                                <div class="input-prepend input-append">
                                    <span class="add-on">URL:</span>
                                    <input style="margin-left:20px;" type="text" id='second_url' name='second_url' value="" placeholder="推送跳转URL"/>
                                </div>
                            </div>
                            <div style="margin-top:20px">
                                <p style="color:red;font-size:18px">强调声明：</p>
                                <ol>
                                    <li>模板编辑内容中不可含有除《》以外的其他特殊书名符号。</li>
                                    <li>如果所选项目中含有，请编辑者自行修改项目名称以及简介中的内容。</li>
                                    <li>否侧该模板内容由于内容不符合格式导致发送失败。</li>
                                </ol>
                            </div> 
                        </div>
                        <div style="float: left;margin-left: 630px;margin-top: -420px;">
                            <a href="javascript:;" id="close" class="close">模板(样例)介绍</a><hr>
                            <div class="wechat_jy">
<!--                                <div></div>-->
                                <p class="wechat_bold">一条新的众筹项目推荐</p>
                                <p class="wechat_p">8月8日</p>
                                <div>
                                    <span>项目名称：</span>
                                    <span>体验一条鱼的故事——唯美创意体验式游戏《鲤》</span>
                                </div>
                                <div>
                                    <span>目标金额：</span>
                                    <span>¥10,000</span>
                                    </div>
                                <div>
                                    <span>结束时间：</span>
                                    <span>2015-02-06 00:00:00</span>
                                </div>
                                <div>
                                    <span>项目简介：</span>
                                    <span>这是一段关于创意和美无限结合的体验，荷塘、鱼、花，简单唯美，独立游戏《鲤》讲述了一个以小博大的故事。</span>
                                </div>
                                <p>点击查看项目视频、介绍、回报等详情。>>>>>>>>>></p>
                            </div>
                            <div style="float:left">
<!--                                <p style="color:red;margin-left: 250px;margin-top: -255px;">这里是Topcolor</p>-->
                                <p style="color:red;margin-left: 250px;margin-top: -240px;">这里是FirstData</p>                                
                            </div>
                            <div style="float:left">
                                <p style="color:red;margin-left: 250px;margin-top: -30px;">这里是Remark</p>
                            </div>
                        </div>
                    </div>									
                    <div id="temeplate_3" style="display:none;">
                        <div id="edit_pro" class="edit_pro">
                            <div class="row-fluid">
                                <div class="input-prepend input-append">
                                    <span class="add-on">FirstData:</span>
                                    <input style="margin-left:20px;" type="text" id='second_data3' name='second_data3' value="" placeholder="推送标题"/>
                                </div>
                            </div>						
                            <div class="row-fluid">
                                <div class="input-prepend input-append">
                                    <span class="add-on">Remark:</span>
                                    <input style="margin-left:20px;" type="text" id='second_remark3' name='second_remark3' value="" placeholder="推送footer"/>
                                </div>
                            </div>						
                            <div class="row-fluid">
                                <div class="input-prepend input-append">
                                    <span class="add-on">URL:</span>
                                    <input style="margin-left:20px;" type="text" id='second_url3' name='second_url3' value="" placeholder="推送跳转URL"/>
                                </div>
                            </div>																			
                        </div>
                        <div style="float: left;margin-left: 630px;margin-top: -100px;">                        
                            <div class="wechat_jy">
                                
                                <p class="wechat_bold">账户未绑定通知</p>
                                <p class="wechat_p">8月8日</p>
                                <div>
                                    <span>微信号：</span>
                                    <span>xxxxxx</span>
                                </div>
                                <div>
                                    <span>绑定状态：</span>
                                    <span>未绑定</span>
                                </div> 
                                <p>点击绑定账号>>>>>>>>>></p>
                            </div>
                            <div style="float:left">
<!--                                <p style="color:red;margin-left: 250px;margin-top: -130px;">这里是Topcolor</p>-->
                                <p style="color:red;margin-left: 250px;margin-top: -105px;">这里是FirstData</p>                                
                            </div>
                            <div style="float:left">
                                <p style="color:red;margin-left: 250px;margin-top: -30px;">这里是Remark</p>
                            </div>
                        </div>
                    </div>
                    <div class="span1" style="margin:40px">                 
                        <a id="submit_next_3" class="btn btn-primary" href="javascript:;" style="width:150px">下一步</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><br>
                    </div>              											
                </div>				
                <div id="forth_step" style="display:none;">
                    <div  class="edit_pro">
                        <div class="row-fluid">
                            <div class="input-prepend input-append">
                                <span class="add-on">标题：</span>
                                <input style="margin-left:20px;" type="text" id='forth_title' name='forth_title' value="" readOnly="true"/>
                            </div>
                        </div>						
                        <div class="row-fluid">
                            <div class="input-prepend input-append">
                                <span class="add-on">模板:</span>
                                <input style="margin-left:20px;" type="text" id='forth_tpl_name' name='forth_tpl_name' value="" readOnly="true"/>
                            </div>
                        </div>						
                        <div class="row-fluid">
                            <div class="input-prepend input-append">
                                <span class="add-on">用户筛选条件:</span>
                                <input style="margin-left:20px;" type="text" id='forth_deals' name='forth_deals' value="" readOnly="true"/>
                            </div>
                        </div>						
                        <div class="row-fluid">
                            <div class="input-prepend input-append">
                                <span class="add-on">当前排重用户数:</span>
                                <input style="margin-left:20px;" type="text" id='forth_count' name='forth_count' value="" readOnly="true"/>
                            </div>
                        </div>
                        <div class="row-fluid">
                            <div class="input-prepend input-append">
                                <span class="add-on">设置推广时间:</span>
                                <div id="spread_time_sel">
                                    <label class="radio inline">
                                        <input type="radio" name="spread_type" value="1" checked="checked"/>定时整点推送
                                        <span id="datetimepicker" class="input-append">
                                            <input data-format="yyyy-MM-dd hh:00" type="text" placeholder="开始时间" name='prostart_time' id='prostart_time' value='' />
                                            <span class="add-on">
                                                <i data-time-icon="icon-time" data-date-icon="icon-calendar"></i>
                                            </span>
                                        </span>

                                    </label><br/>
                                    <label class="radio inline">
                                        <input type="radio" name="spread_type" value="2" />一小时内推送
                                    </label>
                                </div>								
                            </div>
                        </div>																																												
                    </div>                  
                    <div class="span1" style="margin:40px">                 
                        <a id="new_wxspread_submit" class="btn btn-primary" href="javascript:;" style="width:150px">提交</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><br>
                    </div>               											

                </div>											
            </div>					
        </form>
        <!-- 新建用户群 -->
        <div id="create_user_arr" class="white_content">
            <a href="javascript:;" id="close" class="close">Close</a><hr>
            <div>
                <div id="edit_pro" class="edit_pro">
                    <div class="row-fluid">
                        <div class="input-prepend input-append">
                            <span class="add-on">用户组名称:</span>
                            <input style="margin-left:20px;" type="text" id='new_user_name' name='new_user_name' value="" placeholder=""/>
                            <span class="add-on">用户组刷选范围说明:</span>
                            <input style="margin-left:20px;" type="text" id='new_user_deal' name='new_user_deal' value="" placeholder=""/>
                            
                        </div>
                    </div>
                    <div style="border:1px dashed #808080;margin-top:10px;" id="user_status">					
                        <div class="row-fluid" style="margin:10px">

                            <div class="input-prepend input-append" style="width:316px">
                                <span class="add-on">选择用户属性:</span>
                                <a id="user-add" href="javascript:;" role="button">添加</a>
                            </div>
                            <div class="input-prepend input-append" >
                                <select  name="user_type[]" id="user_type_0">
                                    <option value="1">注册时间</option>
                                    <option value="2">最后访问时间</option>
                                    <option value="3">是否绑定微信号</option>
                                    <option value="4">注册来源</option>
                                    <option value="5">用户标签</option>
                                    <option value="6">支持过项目</option>
                                    <option value="7">支持项目数</option>
                                    <option value="8">关注过项目</option>
                                    <option value="9">关注项目数</option>
                                    <option value="10">累计支持金额</option>
                                    <option value="11">平均支持金额</option>
                                    <option value="12">是否绑定手机号（登录用）</option>
                                    <option value="13">是否绑定邮箱（登录用）</option>
                                    <option value="14">用户性别</option>
                                </select>
                                <select  name="user_meth[]" style="width:50px;">
                                    <option value="0">为</option>
                                    <option value="1">></option>
                                    <option value="2"><</option>
                                    <option value="3">=</option>
                                    <option value="4"><=</option>
                                    <option value="5">>=</option>
                                    <option value="6">!=</option>
                                </select>
                                <input id="create_0" class="select_value" style="float:right;margin-right:180px;" type="text"  name='create_content[]' value="" placeholder=""/>

                            </div>
                        </div>	
                        <div id="user_item" style="margin:10px">
                        </div>																	                     	                    															                     	                    																										                     	                    															                     	                    																											                     	                    															                     	                    																										                     	                    															                     	                    																											                     	                    															                     	                    																										                     	                    															                     	                    																										
                    </div>
                </div>										
            </div>
            <div class="input-prepend input-append" style="width:316px;margin-top:20px">
                <a href="javascript:;" id="select_user" class="select_user btn btn-info" style="color:#EEEEEE;text-decoration:none;">点击查询用户数</a>
                <br><br>
                <span class="add-on">查询结果:</span>
                <input style="margin-left:20px;" type="text"  name='selcount' id="selcount" value="" />

            </div>
            <div>
                <p style="color:red;">填写说明：</p>
                <ol>
                    <li>此创建框为复选多条件</li>
                    <li>如果选择了时间类条件，请在后面的输入框内填写时间格式（例如：1997-12-12 00:00:00）</li>
                    <li>如果选择判断类条件，请在后面输入判断格式（例如：是/否）</li>
                    <li>注册来源：weibo;qq;weixin;web;wap等</li>
                    <li>数字类条件，请填写有效数字;若为多条件请用“英文”;分开</li>
                    <li>文字类条件，填写时请用“英文”,分开</li>
                </ol>
            </div>                         
            <div class="span1" style="margin:40px">                 
                <a id="user_submit" class="btn btn-primary" href="javascript:;" style="width:150px">保存</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><br>
            </div>               														
        </div>		
        <!-- 新建用户群结束 -->
    </div>
</div>
<div id="fade" class="black_overlay"> 
</div> 
<script type="text/javascript">
    $(document).ready(function() {
        $(":checkbox").click(function() {
            if ($(this).attr("checked") != undefined)
            {
                $(this).siblings().attr("checked", false);
                $(this).attr("checked", true);
            }
        });
        $("#pro_tab>.btn").click(function() {
            var index = $(this).index();
            $("#pro_tab>.btn").removeClass('active');
            $(this).addClass('active');
            var div = $("#p1>div");
            div.hide();
            div.eq(index).show();
        });
        $("#submit_next_1").click(function() {

            $("#first_step").hide();
            $("#second_step").show();
            $(".first_slider").removeClass('active');
            $(".second_slider").addClass('active');
            
        });       
        $("#submit_next_2 , .third_slider").click(function() {

            var template = $('input[name="template_select"]:checked').val();
            var spread_title = $('#new_spread_title').val();
            if (spread_title.length == 0 || template == '') {
                alert("请输入“推广标题” 或者确定“推广模板”");
                return false;
            }

            if (spread_title.length > 15) {
                alert("“推广标题” 不能超过 15 个字");
                return false;
            }
            if (template == '10') {
                $("#first_step").hide();
                $("#second_step").hide();
                $("#third_step").show();
                $("#temeplate_1").show();
                $("#temeplate_3").hide();
                $("#temeplate_3 :input").val('');
                
                
            }
            if (template == '13') {
                $("#first_step").hide();
                $("#second_step").hide();
                $("#third_step").show();
                $("#temeplate_3").show();
                var url3 = '<?=_gc('domain_wap', 'domain')?>/u/wx_public_login';
                $("#second_url3").val(url3);
                $("#temeplate_1").hide();
                $("#temeplate_1 :input").val('');
                
                
            }
            $(".first_slider").removeClass('active');
            $(".second_slider").removeClass('active');
            $(".third_slider").addClass('active');
        });

        $("#submit_next_3").click(function() {
            var tpl_id = $('input[name="template_select"]:checked').val();
            if(tpl_id == 10){           
                var second_data = $('#second_data').val();
                var second_dec = $('#text').val();
                var second_remark = $('#second_remark').val();

                var data_len = getByteLen(second_data);
                var dec_len = getByteLen(second_dec);
                var remark_len = getByteLen(second_remark);

                if (data_len == 0) {
                    alert("请输入“FirstData”");
                    return false;
                }
                if (data_len > 30) {
                    alert("“FirstData” 不能超过 15 个字");
                    return false;
                }
                if (dec_len == 0) {
                    alert("请输入项目简介");
                    return false;
                }
                if (dec_len > 218) {
                    alert("项目简介不能超过 109 个字");
                    return false;
                }
                if (remark_len == 0) {
                    alert("请输入“Remark”");
                    return false;
                }
                if (remark_len > 24) {
                    alert("“Remark”不能超过 12 个字");
                    return false;
                }
            }
            if(tpl_id == 13){            
                var second_data = $('#second_data3').val();
                var second_remark = $('#second_remark3').val();

                var data_len = getByteLen(second_data);
                var remark_len = getByteLen(second_remark);

                if (data_len == 0) {
                    alert("请输入“FirstData”");
                    return false;
                }
                if (data_len > 30) {
                    alert("“FirstData” 不能超过 15 个字");
                    return false;
                }              
                if (remark_len == 0) {
                    alert("请输入“Remark”");
                    return false;
                }
                if (remark_len > 24) {
                    alert("“Remark”不能超过 12 个字");
                    return false;
                }
            }
            $("#third_step").hide();
            $("#forth_step").show();
            $(".third_slider").removeClass('active');
            $(".forth_slider").addClass('active');
            var new_spread_title = $("#new_spread_title").val();
            var wx_tpl = $('input[name="template_select"]:checked').attr('wx_tpl_name');
            var status_deals = $("#user_arr_sel input[type=radio]:checked").attr('status_deals');
            var status_id = $("#user_arr_sel input[type=radio]:checked").val();

            $("#forth_title").val(new_spread_title);
            $("#forth_tpl_name").val(wx_tpl);
            $("#forth_deals").val(status_deals);
            $.ajax({
                type: "POST",
                url: "/weixin_manage/ajax_status_count/",
                traditional: true,
                data: {
                    status_id: status_id,
                },
                dataType: 'json',
                success: function(data) {
                    if (data.status == 1) {
                        $("#forth_count").val(data.count);
                    }
                },
            });            
        });

        $("#topic_up").click(function() {
            var pro_id = $("#pro_id").val();
            var reg = new RegExp("^[1-9][0-9]*$");
            if (!reg.test(pro_id)) {
                alert('请输入合法的项目ID');
                //$("#single_id")[0].focus();
                return false;
            }
            $.ajax({
                type: "POST",
                url: "/user_ajax/get_pro_mess/",
                data: {
                    productId: pro_id
                },
                dataType: "json",
                success: function(data) {
                    if (data.status == 0) {
                        alert('没有查询到对应的项目名称,请核对项目ID后重新输入');
                        return false;
                    } else {
                        var rem = '点击查看项目详情。';
                        var pro_url = '<?=_gc('domain_wap', 'domain')?>/project/'+pro_id+'.html';
                        $("#pro_name").val(data.pro_title);
                        $("#pro_goal").val(data.pro_goal);
                        $("#pro_end_time").val(data.end_time);
                        $("#text").val(data.pro_des);
                        $("#second_url").val(pro_url);
                        $("#second_remark").val(rem);
                    }
                },
            });
        });
        $("#create_user").click(function() {
            $("#create_user_arr").css('display', 'block');
            $('#fade').css('display', 'block');
        });
        $('#create_user_arr #close').click(function() {
            $('#create_user_arr').css('display', 'none');
            $('#fade').css('display', 'none');
        });

        var num = 0;
        $('a#user-add').on('click', function(evt) {
            evt.preventDefault();
            num++;
            var html = '<div class="user_list" >';
            html += '<div class="input-prepend input-append" >';
            html += '<a href="#" class="close del-subjpro-id-item">&times;</a>';
            html += '<select  name="user_type[]"id="user_type_' + num + '" >';
            html += '<option value="1">注册时间</option>';
            html += '<option value="2">最后访问时间</option>';
            html += '<option value="3">是否绑定微信号</option>';
            html += '<option value="4">注册来源</option>';
            html += '<option value="5">用户标签</option>';
            html += '<option value="6">支持过项目</option>';
            html += '<option value="7">支持项目数</option>';
            html += '<option value="8">关注过项目</option>';
            html += '<option value="9">关注项目数</option>';
            html += '<option value="10">累计支持金额</option>';
            html += '<option value="11">平均支持金额</option>';
            html += '<option value="12">是否绑定手机号（登录用）</option>';
            html += '<option value="13">是否绑定邮箱（登录用）</option>';
            html += '<option value="14">用户性别</option>';
            html += '</select>';
            html += '<select  name="user_meth[]" style="width:50px;margin-left:5px">';
            html += '<option value="0">为</option>';
            html += '<option value="1">></option>';
            html += '<option value="2"><</option>';
            html += '<option value="3">=</option>';
            html += '<option value="4"><=</option>';
            html += '<option value="5">>=</option>';
            html += '<option value="6">!=</option>';
            html += '</select>';
            html += '<input class="select_value" id="create_' + num + '" style="float:right;margin-right:150px;" type="text"  name=\'create_content[]\' value="" placeholder=""/>';
            html += '<select  name="meth[]" style="width:50px;float:right;margin-right:-315px">';
            html += '<option value="1">且</option>';
            html += '<option value="2">或</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            $('#user_item').append(html);
            $('.datetimepicker2').datetimepicker({
                language: 'zh-CN',
                pickTime: false
            }).attr('readonly', 'readonly');
        });

        $('#user_item').on('click', '.user_list a.del-subjpro-id-item', function(evt) {
            evt.preventDefault();
            $(this).parent().remove();
        });

        $("#select_user").click(function(e) {
            var content = [];
            var sel_type = [];
            var sel_status = [];
            var sel_meth = [];
            var user_type = document.getElementsByName("user_type[]");
            var user_meth = document.getElementsByName("user_meth[]");
            var create_content = document.getElementsByName("create_content[]");
            var meth = document.getElementsByName("meth[]");
            for (var i = 0; i < user_type.length; i++) {
                if (user_type[i].value == '') {
                    alert("请选择筛选条件限制");
                    return false;
                } else {
                    sel_type[i] = user_type[i].value;
                }
            }
            for (var j = 0; j < user_meth.length; j++) {
                if (user_meth[j].value == '') {
                    alert("请选择条件属性");
                } else {
                    sel_status[j] = user_meth[j].value;
                }
            }
            for (var m = 0; m < create_content.length; m++) {
                if (create_content[m].value == '') {
                    alert("请输入筛选条件内容");
                    return false;
                } else {
                    content[m] = create_content[m].value;
                }
            }
            if (meth.length != 0) {
                for (var n = 0; n < meth.length; n++) {
                    if (meth[n].value == '') {
                        alert("请选择各条件之间的关系");
                        return false;
                    } else {
                        sel_meth[n] = meth[n].value;
                    }
                }
            }
            user_type = JSON.stringify(sel_type);
            user_meth = JSON.stringify(sel_status);
            create_content = JSON.stringify(content);
            meth = JSON.stringify(sel_meth);
            $.ajax({
                type: "POST",
                url: "/weixin_manage/ajax_user_count/",
                traditional: true,
                data: {
                    user_type: user_type,
                    user_meth: user_meth,
                    create_content: create_content,
                    meth: meth
                },
                dataType: 'json',
                success: function(data) {
                    if (data.status == -1) {
                        alert("在所选条件下用户数为“0”");
                        return false;
                    }
                    if (data.status == 1) {
                        $("#selcount").val(data.count);
                    }
                },
            });
        });
        $("#user_submit").click(function() {
            var content = [];
            var sel_type = [];
            var sel_status = [];
            var sel_meth = [];
            var user_type = document.getElementsByName("user_type[]");
            var user_meth = document.getElementsByName("user_meth[]");
            var create_content = document.getElementsByName("create_content[]");
            var meth = document.getElementsByName("meth[]");
            var new_user_name = $("#new_user_name").val();
            var new_user_deal = $("#new_user_deal").val();
            for (var i = 0; i < user_type.length; i++) {
                if (user_type[i].value == '') {
                    alert("请选择筛选条件限制");
                    return false;
                } else {
                    sel_type[i] = user_type[i].value;
                }
            }
            for (var j = 0; j < user_meth.length; j++) {
                if (user_meth[j].value == '') {
                    alert("请选择条件属性");
                } else {
                    sel_status[j] = user_meth[j].value;
                }
            }
            for (var m = 0; m < create_content.length; m++) {
                if (create_content[m].value == '') {
                    alert("请输入筛选条件内容");
                    return false;
                } else {
                    content[m] = create_content[m].value;
                }
            }
            if (meth.length != 0) {
                for (var n = 0; n < meth.length; n++) {
                    if (meth[n].value == '') {
                        alert("请选择各条件之间的关系");
                        return false;
                    } else {
                        sel_meth[n] = meth[n].value;
                    }
                }
            }
            user_type = JSON.stringify(sel_type);
            user_meth = JSON.stringify(sel_status);
            create_content = JSON.stringify(content);
            meth = JSON.stringify(sel_meth);
            $.ajax({
                type: "POST",
                url: "/weixin_manage/add_new_user_arr/",
                traditional: true,
                data: {
                    new_user_name: new_user_name,
                    new_user_deal: new_user_deal,
                    user_type: user_type,
                    user_meth: user_meth,
                    create_content: create_content,
                    meth: meth
                },
                dataType: 'json',
                success: function(data) {
                    if (data.status == -1) {
                        alert("该刷选用户群已经存在！");
                        return false;
                    }
                    if (data.status == 1) {
                        location.reload();
                    }
                },
            });
        });
        $(document).on('click', '.users_nums .ths_users a', function() {
            var nhtml = $(this);
            var status_id = $(this).attr("status_id");
            $.ajax({
                type: "POST",
                url: "/weixin_manage/ajax_status_count/",
                traditional: true,
                data: {
                    status_id: status_id,
                },
                dataType: 'json',
                success: function(data) {
                    if (data.status == 1) {
                        var html = '';
                        html += '<span class="ths_users">' + data.count + '<a status_id="' + data.status_id + '" style="margin-left:20px;" class="ajax_user" href="javascript:;">刷新用户</a>';
                        html += '</span>';
                        nhtml.parent().html(html);
                    }
                },
            });
        });

        $("#new_wxspread_submit").click(function() {           
            var spread_title = $('#forth_title').val();
            var user_status_id = $("#user_arr_sel input[type=radio]:checked").val();
            var send_type = $("#spread_time_sel input[type=radio]:checked").val();
            if (send_type == 1) {
                var send_time = $('#prostart_time').val();
            } else {
                var send_time = 0;
            }
            var send_wx_tpl = $('input[name="template_select"]:checked').val();
            var wx_tpl_content = '';
            if(send_wx_tpl == 10){
                 var send_pro_id = $('#pro_id').val();
                 var wx_tpl_firstdata = $('#second_data').val();
                 var wx_tpl_proname = $('#pro_name').val();
                 var wx_tpl_progoal = $('#pro_goal').val();
                 var wx_tpl_endtime = $('#pro_end_time').val();
                 var wx_tpl_procon = $('#text').val();
                 var wx_tpl_remark = $('#second_remark').val();
                 var wx_tpl_url = $('#second_url').val();
                 wx_tpl_content = wx_tpl_firstdata+'^'+wx_tpl_proname+'^'+wx_tpl_progoal+'^'+wx_tpl_endtime+'^'+wx_tpl_procon+'^'+wx_tpl_remark+'^'+wx_tpl_url;
            }
            if(send_wx_tpl == 13){
                var send_pro_id = 0;
                var wx_tpl_firstdata = $('#second_data3').val();
                var wx_tpl_remark = $('#second_remark3').val();
                var wx_tpl_url = $('#second_url3').val();
                wx_tpl_content = wx_tpl_firstdata+'^'+wx_tpl_remark+'^'+wx_tpl_url;
            }
            $.ajax({
                type: "POST",
                url: "/weixin_manage/add_weixin_spread/",
                traditional: true,
                data: {
                    send_pro_id:send_pro_id,
                    spread_title:spread_title,
                    user_status_id:user_status_id,
                    send_type:send_type,
                    send_time:send_time,
                    send_wx_tpl:send_wx_tpl,
                    wx_tpl_content:wx_tpl_content
                },
                dataType: 'json',
                success: function(data) {
                    if(data.status == -1){
                        alert('该推送模板已经存在；请进行修改');
                        return false;
                    }
                    if (data.status == 1) {
                        alert('新推送模板创建成功');
                        location.replace('/weixin_manage/weixin_spread');
                    }
                },
            });
           
        });

    });
</script>
<script>
    function getByteLen(val) {
        var len = 0;
        for (var i = 0; i < val.length; i++) {
            var a = val.charAt(i);
            if (a.match(/[^\x00-\xff]/ig) != null) {
                len += 2;
            } else {
                len += 1;
            }
        }
        return len;
    }
    function selectUser(selectId) {
        var select_user_type = $('#user_type_' + selectId + ' option:selected').val();
        if (select_user_type == 1 || select_user_type == 2) {

            $("#user_type_" + selectId).parents().find("#datetime_" + selectId).show();
            $("#user_type_" + selectId).parents().find("#create_" + selectId).hide();
        } else {
            $("#user_type_" + selectId).parents().find("#datetime_" + selectId).hide();
            $("#user_type_" + selectId).parents().find("#create_" + selectId).show();
        }
    }
</script>
<?php
$this->load->view('ckad/footer')?>