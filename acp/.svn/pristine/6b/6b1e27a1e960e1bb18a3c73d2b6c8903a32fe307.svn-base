<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

require_once BASEPATH . 'libraries/md_memcache.php';

class Weidashang extends Acp_Controller {

	public function __construct() {
		parent::__construct();
		$this->db->read_main = true;
		$this->load->helper('url');
		$this->load->helper('util');
		$this->load->helper('excel');
                $this->load->library('md_model_cache');
                $this->load->library('md_payment_batch_draw');
                $this->load->library('md_payment_weixin');
                $this->load->library('md_weidashang');
		$this->load->model('User_m');
		$this->load->library('md_refund');
                $this->load->model('Order_biz');
		$this->load->model('Wds_acp_m');
		$this->load->library('md_common');
	}

	/**
	 * 摩点点项目活动后台
	 * Enter description here ...
	 */
	public function choudiandian_pro(){
		$data = array();
		$pro_name_arr = $this->Wds_acp_m->get_diandian_pro_name();
		$data['pro_name_arr'] = $pro_name_arr;
		$this->load->view('weidashang/diandian_pro', $data);
			
	}

	/**
	 * 筹点点后台search查询的ajax最终组合方法
	 * Enter description here ...
	 */
	public function ajax_diandian_pro(){
		$res = array();
		$result = array();
		$res = $this->diandian_pro_search(1);
			
		$result = array('total' =>$res["num"],
    			'rows' =>$res["search"],
    			'footer' => '',
		);
			
		echo json_encode($result);
	}

	/**
	 * 筹点点后台查询详细方法
	 * Enter description here ...
	 * @param unknown_type $mode
	 */
	public function diandian_pro_search($mode=1){

		$search_arr["pro_id"] = isset($_POST['pro_id']) ? $_POST['pro_id'] : '';
		$search_arr["pro_name"] = isset($_POST['content_template']) ? $_POST['content_template']: '';
		$search_arr["start_time"] = isset($_POST['start_time']) ? $_POST['start_time'] : '';
		$search_arr["end_time"] = isset($_POST['end_time']) ? $_POST['end_time'] : '';
		$search_arr["sort"] = isset($_POST['bysort']) ? $_POST['bysort'] : 'id';
		$search_arr["order"] = isset($_POST['byorder']) ? $_POST['byorder'] : 'asc';
		$search_arr["type"] = isset($_POST['create_type']) ? $_POST['create_type'] : '';
			
		if($mode == 2){
			$search_arr["page"] = "";
			$search_arr["rows"] = "";
		}else{
			$search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
			$search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';
		}
			
		$search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
		$search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';

		$start = ($search_arr["page"] > 1)?($search_arr["page"] -1)*$search_arr["rows"]:0;
		$end = ($search_arr["page"] > 1)?($search_arr["page"])*$search_arr["rows"]:$search_arr["rows"];
		$result = $this->Wds_acp_m->pro_mes_serach($search_arr);
                $num = $this->Wds_acp_m->pro_mes_serach($search_arr,-1);
		//print_r($result);exit;
		$list_info = array();
		if(!empty($result)){
			foreach ($result as $key=>$val){
				$res["id"] = $val["id"];
				if($val["type"] == '0'){
					$res["pro_type"] = "微打赏-活动";
				}
				$res["pro_name"] = $val["topic"];
				if($val["ctime"] == "0000-00-00 00:00:00"){
					$res["create_time"] ='';
				}else{
					$res["create_time"] =$val["ctime"];
				}
				$res["start_time"] =$val["effect_time"];
				$res["end_time"] =$val["end_time"];
				$res["op_user"] =$val["user_name"];
				if($val["if_show"] == '1'){
					$res["work"] = '<a href="/weidashang/edit_pro/'.$val["id"].'" id="edit" class="edit">编辑</a> | <a href="/weidashang/down_pro/'.$val["id"].'" id="down_pro" class="down_pro" onclick="if(confirm(\'确实要将活动<' .$val["topic"].'>下线吗？\')) return true;else return false;">下线</a> | <a href="/weidashang/show_pro_sub/'.$val["id"].'" id="show_sub_pro" class="show_sub_pro">查看参与项目</a>';
				}elseif($val["if_show"] == '0'){
					$res["work"] = '<a href="/weidashang/edit_pro/'.$val["id"].'" id="edit" class="edit">编辑</a> | <a href="/weidashang/go_pro/'.$val["id"].'" id="go_pro" class="go_pro" onclick="if(confirm(\'确实要将活动<' .$val["topic"].'>上线吗？\')) return true;else return false;">上线</a> | <a href="/weidashang/show_pro_sub/'.$val["id"].'" id="show_sub_pro" class="show_sub_pro">查看参与项目</a>';
				}
				if($val["if_recommend"] == '1'){
					$res["recommend"] = '<a href="/weidashang/abandon_recommend_pro/'.$val["id"].'" id="abandon_recommend_pro" class="abandon_recommend_pro" onclick="if(confirm(\'确实要放弃推荐<' .$val["topic"].'>吗？\')) return true;else return false;">放弃推荐</a>';
				}elseif($val["if_recommend"] == '0'){
					$res["recommend"] ='<a href="/weidashang/recommend_pro/'.$val["id"].'" id="recommend_pro" class="recommend_pro" onclick="if(confirm(\'确实要推荐<' .$val["topic"].'>吗？\')) return true;else return false;">推荐轮播</a>';
				}
				$logo = cdn_url($val["logo"]);
				$res["logo"] = '<img src="'.$logo.'" style="width:80px;height:80px"/>';
				$res["goal"] = $val["goal"];
				$res["inner_user_num"] = $val["active_nums"];
				$res["topic_all_money"] = $val["all_amount"];
				$list_info[] = $res;
			}
		}
		//根据支持人数/钱数重新排序
		foreach($list_info as $key=>$value){
			if($search_arr["sort"] == 'inner_user_num'){
				$inner[$key] = $value['inner_user_num'];
			}elseif($search_arr["sort"] == 'topic_all_money'){
				$inner[$key] = $value['topic_all_money'];
			}
		}
		if($search_arr["order"] == 'asc'){
			array_multisort($inner, SORT_ASC,$list_info);
		}elseif($search_arr["order"] == 'desc'){
			array_multisort($inner, SORT_DESC,$list_info);
		}
			
		$diadian_list_info = array();
		$diadian_list_info["search"]= $list_info;
                $diadian_list_info["num"]= $num;
		return $diadian_list_info;
	}

	/**
	 * 筹点点后台创建活动
	 * Enter description here ...
	 */
	public function create_diandian_pro(){
		$pro_name = isset($_POST["new_pro_name"])?$_POST["new_pro_name"]:"";
		$pro_money = isset($_POST["new_pro_money"])?$_POST["new_pro_money"]:"";
		$logo = isset($_POST["topic_pic_hidden"])?$_POST["topic_pic_hidden"]:"";
		$tag = isset($_POST["new_pro_tag"])?$_POST["new_pro_tag"]:"";
		$start_time = isset($_POST["prostart_time"])?$_POST["prostart_time"]:"";
		$intro = isset($_POST["new_pro_des"])?$_POST["new_pro_des"]:"";
		$des = isset($_POST["pro_con"])?$_POST["pro_con"]:"";
		$effect_day = isset($_POST["new_pro_time"])?$_POST["new_pro_time"]:"";
		$pro_share_title = isset($_POST["pro_share_title"])?$_POST["pro_share_title"]:"";
		$pro_share_des= isset($_POST["pro_share_des"])?$_POST["pro_share_des"]:"";
		$user_id = $_SESSION['admin_id'];
		$op_man = $this->md_refund->get_op_name($_SESSION['admin_id']);
		$ctime = date("Y-m-d H:i:s");
		$end_time = date("Y-m-d H:i:s", $effect_day * 24 * 3600 + strtotime($start_time));
		$unit_key = md5 ( $pro_name . '_' . $tag . '_' . $intro );
		$type = 0;
		$if_show = 0;
		$data = array(
 			'user_id' => $user_id,
 			'user_name' => $op_man,
 			'topic' => $pro_name,
 			'effect_day' => $effect_day,
 			'tag' => $tag,	
 			'logo' => $logo,
 			'intro' => $intro,
 			'des' => $des,
 			'if_show' => $if_show,
 			'unit_key' => $unit_key,
 			'type' => $type,		 			
 			'ctime' => $ctime,
 			'effect_time' =>$start_time,
 			'end_time' => $end_time,
 			'goal' => $pro_money,
 			'pro_share_title' => $pro_share_title,
 			'pro_share_des' => $pro_share_des	
		);
		 
		$if_pro = $this->Wds_acp_m->if_pro($unit_key);
		if(!empty($if_pro)){
			echo "<script>alert('该活动已经创建过!')</script>";
			return false;
		}else{
			$inner_new_pro = $this->Wds_acp_m->inner_new_pro($data);
			echo "<script>alert('创建成功')</script>";
			return true;
		}
	}

	/**
	 * 筹点点后台进入活动编辑更新页面
	 * Enter description here ...
	 * @param unknown_type $id
	 */
	public function edit_pro($id){
		$data = array();
		$pro_mess = $this->Wds_acp_m->get_edit_pro_mess($id);
		$data['pro_mess'] = $pro_mess;
		$this->load->view('weidashang/diandian_edit_pro', $data);

	}

	/**
	 * 筹点点活动更新
	 * Enter description here ...
	 * @param unknown_type $pro_id
	 */
	public function update_diandian_pro($pro_id){
		$pro_name = isset($_POST["new_pro_name"])?$_POST["new_pro_name"]:"";
		$pro_money = isset($_POST["new_pro_money"])?$_POST["new_pro_money"]:"";
		$logo = isset($_POST["topic_pic_hidden"])?$_POST["topic_pic_hidden"]:"";
		$tag = isset($_POST["new_pro_tag"])?$_POST["new_pro_tag"]:"";
		$intro = isset($_POST["new_pro_des"])?$_POST["new_pro_des"]:"";
		$des = isset($_POST["pro_con"])?$_POST["pro_con"]:"";
		$effect_day = isset($_POST["new_pro_time"])?$_POST["new_pro_time"]:"";
		$start_time = isset($_POST["start_time"])?$_POST["start_time"]:"";
		$pro_share_title = isset($_POST["pro_share_title"])?$_POST["pro_share_title"]:"";
		$pro_share_des= isset($_POST["pro_share_des"])?$_POST["pro_share_des"]:"";
		$user_id = $_SESSION['admin_id'];
		//$op_man = $this->md_refund->get_op_name($_SESSION['admin_id']);
		$ctime = date("Y-m-d H:i:s");
		$end_time = date("Y-m-d H:i:s", $effect_day * 24 * 3600 + strtotime($start_time));
		$unit_key = md5 ( $pro_name . '_' . $tag . '_' . $intro );
		$type = 0;
		$data = array(
 			'topic' => $pro_name,
 			'effect_day' => $effect_day,
 			'tag' => $tag,	
 			'logo' => $logo,
 			'intro' => $intro,
 			'des' => $des,
 			'unit_key' => $unit_key,
 			'type' => $type,		 			
 			'ctime' => $ctime,
 			'end_time' => $end_time,
 			'goal' => $pro_money,
 			'pro_share_title' => $pro_share_title,
 			'pro_share_des' => $pro_share_des	
			
		);
		$update_new_pro = $this->Wds_acp_m->update_pro_mess($pro_id,$data);
		return true;
	}

	/**
	 * 筹点点后台-下线活动
	 * Enter description here ...
	 * @param unknown_type $pro_id
	 */
	public function down_pro($pro_id){
		$topic_mess =  $this->Wds_acp_m->get_topic_info($pro_id);
		$down_diandian_pro = $this->Wds_acp_m->down_diandian_pro($pro_id);
		redirect("/weidashang/choudiandian_pro");
		return true;
	}

	/**
	 * 筹点点后台-上线活动
	 * Enter description here ...
	 * @param unknown_type $pro_id
	 */
	public function go_pro($pro_id){
		$topic_mess =  $this->Wds_acp_m->get_topic_info($pro_id);
		$go_diandian_pro = $this->Wds_acp_m->go_diandian_pro($pro_id);
		redirect("/weidashang/choudiandian_pro");
		return true;
	}

	/**
	 * 筹点点后台查看活动中的项目列表
	 * Enter description here ...
	 * @param unknown_type $pro_id
	 */
	public function show_pro_sub($pro_id){
		$data = array();
		$sub_pro_arr = $this->Wds_acp_m->get_diandian_pro_sub($pro_id);
		for($i=0;$i < count($sub_pro_arr);$i++){
			$pro_cuser = $this->User_m->get_user_info ( $sub_pro_arr[$i]['user_id'] );
			$sub_pro_arr[$i]['sub_pro_cuser'] = $pro_cuser['nickname'];
			$sub_pro_arr[$i]['sub_back_nums'] = $sub_pro_arr[$i]['pay_count'];
			$logo_arr = unserialize($sub_pro_arr[$i]['logo']);
			$sub_pro_arr[$i]['logo'] = $logo_arr[0];
			$sub_pro_arr[$i]['des'] = mb_strimwidth($sub_pro_arr[$i]['des'],0,130,'...');
			$sub_pro_arr[$i]['sub_back_moneys'] = $sub_pro_arr[$i]['all_amount'];
		}
		$data['topic_id'] = $pro_id;
		$data['sub_list'] = $sub_pro_arr;

		$this->load->view('weidashang/diandian_sub_list', $data);
	}

	//	/**
	//	 * 筹点点后台-设置活动中的部分属性
	//	 * Enter description here ...
	//	 */
	//	public function edit_topic_configuration(){
	//		$topic_id = isset($_POST["topic_id"])?$_POST["topic_id"]:"";
	//		$sort = isset($_POST["bysort"])?$_POST["bysort"]:"asc";
	//		$order = isset($_POST["byorder"])?$_POST["byorder"]:"id";
	//		$money = isset($_POST["money_str"])?$_POST["money_str"]:"1,10,50,80,100,200";
	//		$user_id = $_SESSION['admin_id'];
	//		$op_man = $this->md_refund->get_op_name($_SESSION['admin_id']);
	//		$data = array(
	//        	"topic_id" => $topic_id,
	//        	"sort" => $sort,
	//        	"order" => $order,
	//        	"money" => $money,
	//        	"cuser" => $op_man,
	//		);
	//		$if_topic = $this->Easyfund_m->if_topic($data);
	//		if(!empty($if_topic)){
	//			$updata_topic_config = $this->Easyfund_m->up_topic_config($data);
	//			echo "<script>alert('该活动配置已经更新!')</script>";
	//			redirect("easyfund/choudiandian_pro");
	//		}else{
	//			$add_topic_config = $this->Easyfund_m->add_topic_config($data);
	//			echo "<script>alert('该活动配置设置成功!')</script>";
	//			redirect("weidashang/choudiandian_pro");
	//		}
	//	}
	/**
	 * 筹点点后台-下线项目
	 * Enter description here ...
	 * @param unknown_type $pro_id
	 * @param unknown_type $sub_id
	 */
	public function down_pro_sub($pro_id,$sub_id){

		$down_diandian_pro = $this->Wds_acp_m->down_diandian_sub($sub_id);
		redirect("/weidashang/show_pro_sub/{$pro_id}");
		return true;
	}

	/**
	 * 筹点点后台-上线项目
	 * Enter description here ...
	 * @param unknown_type $pro_id
	 * @param unknown_type $sub_id
	 */
	public function updata_pro_sub($pro_id,$sub_id){

		$up_diandian_pro = $this->Wds_acp_m->updata_diandian_sub($sub_id);
		redirect("/weidashang/show_pro_sub/{$pro_id}");
		return true;
	}

	/**
	 * 筹点点后台-放弃选择推荐活动
	 * Enter description here ...
	 * @param unknown_type $pro_id
	 */
	public function abandon_recommend_pro($pro_id){
		$abandon_pro = $this->Wds_acp_m->abandon_recommend_pro($pro_id);
		redirect("/weidashang/choudiandian_pro");
		return true;
	}

	/**
	 * 筹点点后台-选择推荐活动
	 * Enter description here ...
	 * @param unknown_type $pro_id
	 */
	public function recommend_pro($pro_id){
                $sql = "SELECT count(`id`) as num FROM `md_weidashang_topic` WHERE `if_recommend`=1";
                $count_mes = $this->db->query($sql)->row_array();
                $pro_recount = $count_mes['num'];
                $msql = "SELECT count(`id`) as num FROM `md_weidashang_topic_recom` WHERE `if_recommend`=1";
                $mcount = $this->db->query($msql)->row_array();
                $z_recount = $mcount['num'];
                $all_recount = $pro_recount+$z_recount;
                if($all_recount < 5){
                    $recommend_pro = $this->Wds_acp_m->recommend_pro($pro_id);
                    redirect("/weidashang/choudiandian_pro");
                }else{
                    echo "<script>alert('轮播图不能超过5张！');location.replace('/weidashang/choudiandian_pro');</script>";
                }			
		return true;
	}

	/**
	 * 轮播图自定义
	 * Enter description here ...
	 */
	public function recom_pic(){
		$data = array();
		$pic_name_arr = $this->Wds_acp_m->recoms_name_serach();
		$data['pic_name_arr'] = $pic_name_arr;
		$this->load->view('weidashang/diandian_recom', $data);
	}
	/**
	 *
	 * Enter description here ...
	 */
	public function ajax_recom_pic(){
		$res = array();
		$result = array();
		$res = $this->recom_pic_search(1);
			
		$result = array('total' =>$res["num"],
    			'rows' =>$res["search"],
    			'footer' => '',
		);
			
		echo json_encode($result);
	}

	/**
	 *
	 * Enter description here ...
	 * @param unknown_type $mode
	 */
	public function recom_pic_search($mode=1){

		$search_arr["pic_name"] = isset($_POST['content_template']) ? intval($_POST['content_template']): '';
		if($mode == 2){
			$search_arr["page"] = "";
			$search_arr["rows"] = "";
		}else{
			$search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
			$search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';
		}
			
		$search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
		$search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';

		$start = ($search_arr["page"] > 1)?($search_arr["page"] -1)*$search_arr["rows"]:0;
		$end = ($search_arr["page"] > 1)?($search_arr["page"])*$search_arr["rows"]:$search_arr["rows"];
		$result = $this->Wds_acp_m->recoms_pic_serach($search_arr);
                $num = $this->Wds_acp_m->recoms_pic_serach($search_arr,-1);
		$list_info = array();
		if(!empty($result)){
			foreach ($result as $key=>$val){
				$res["pic_id"] = $val["id"];
				$res["pic_name"] = $val["pic_name"];
				if($val["ctime"] == "0000-00-00 00:00:00"){
					$res["create_time"] ='';
				}else{
					$res["create_time"] =$val["ctime"];
				}
				$pic = cdn_url($val["recom_pic"]);
				$res["pic_show"] = '<img src="'.$pic.'" style="width:80px;height:80px"/>';
				$res["op_user"] =$val["user_name"];
				$res["pic_intro"] =isset($val["pic_intro"]) ? $val["pic_intro"] : '无';;
				if($val["if_recommend"] == '1'){
					$res["recommend"] = '<a href="/weidashang/abandon_recommend/'.$val["id"].'" id="abandon_recommend" class="abandon_recommend" onclick="if(confirm(\'确实要放弃推荐<' .$val["name"].'>吗？\')) return true;else return false;">放弃推荐</a>';
				}elseif($val["if_recommend"] == '0'){
					$res["recommend"] ='<a href="/weidashang/recommend/'.$val["id"].'" id="recommend" class="recommend" onclick="if(confirm(\'确实要推荐<' .$val["name"].'>吗？\')) return true;else return false;">推荐轮播</a>';
				}
				$list_info[] = $res;
			}
		}
		$diadian_list_info = array();
		$diadian_list_info["search"]= $list_info;
                $diadian_list_info["num"]= $num;
		return $diadian_list_info;
	}
	public function add_recom_pic(){
		$logo_name = isset($_POST["pic_name"])?$_POST["pic_name"]:"";
		$logo = isset($_POST["topic_recom_hidden"])?$_POST["topic_recom_hidden"]:"";
		$pic_intro = isset($_POST["pic_intro"])?$_POST["pic_intro"]:"";
		$user_id = $_SESSION['admin_id'];
		$op_man = $this->md_refund->get_op_name($_SESSION['admin_id']);
		$ctime = date("Y-m-d H:i:s");
		$data = array(
 			'user_id' => $user_id,
 			'user_name' => $op_man,
 			'pic_name' => $logo_name,
 			'recom_pic' => $logo,
			'pic_intro' => $pic_intro,
 			'ctime' => $ctime,
		);
		$if_have = $this->Wds_acp_m->if_have_recom($unit_key);
		if(!empty($if_have)){
			echo "<script>alert('该图片已存在!')</script>";
			return false;
		}else{
			$inner_new_recoms = $this->Wds_acp_m->inner_new_recoms($data);
			echo "<script>alert('创建成功')</script>";
			redirect("/weidashang/recom_pic/");
			return true;
		}
	}

	public function abandon_recommend($id){
		$abandon = $this->Wds_acp_m->abandon_recommend($id);
		redirect("/weidashang/recom_pic");
		return true;
	}

	public function recommend($id){
                $sql = "SELECT count(`id`) as num FROM `md_weidashang_topic` WHERE `if_recommend`=1";
                $count_mes = $this->db->query($sql)->row_array();
                $pro_recount = $count_mes['num'];
                $msql = "SELECT count(`id`) as num FROM `md_weidashang_topic_recom` WHERE `if_recommend`=1";
                $mcount = $this->db->query($msql)->row_array();
                $z_recount = $mcount['num'];
                $all_recount = $pro_recount+$z_recount;
                if($all_recount < 5){
                    $recommend = $this->Wds_acp_m->recommend($id);
                    redirect("/weidashang/recom_pic");
                }else{
                    echo "<script>alert('轮播图不能超过5张！');location.replace('/weidashang/recom_pic');</script>";
                }					
		return true;
	}

	public function wds_pro_list(){
		$data = array();
//		$pro_name_arr = $this->Wds_acp_m->get_indenpen_pro_name();
//		$data['pro_name_arr'] = $pro_name_arr;
//		 
		$this->load->view('weidashang/diandian_independent_pro', $data);

	}

	public function ajax_indepen_pro(){
		$res = array();
		$result = array();
		$res = $this->indepen_pro_search(1);
			
		$result = array('total' =>$res["num"],
    			'rows' =>$res["search"],
    			'footer' => '',
		);
			
		echo json_encode($result);

	}

	public function indepen_pro_search($mode=1){

		$search_arr["pro_id"] = isset($_POST['pro_id']) ? $_POST['pro_id'] : '';
		$search_arr["pro_name"] = isset($_POST['content_template']) ? $_POST['content_template']: '';
		$search_arr["start_time"] = isset($_POST['start_time']) ? $_POST['start_time'] : '';
		$search_arr["end_time"] = isset($_POST['end_time']) ? $_POST['end_time'] : '';
		$search_arr["sort"] = isset($_POST['bysort']) ? $_POST['bysort'] : 'id';
		$search_arr["order"] = isset($_POST['byorder']) ? $_POST['byorder'] : 'asc';
			
		if($mode == 2){
			$search_arr["page"] = "";
			$search_arr["rows"] = "";
		}else{
			$search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
			$search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';
		}
			
		$search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
		$search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';

		$start = ($search_arr["page"] > 1)?($search_arr["page"] -1)*$search_arr["rows"]:0;
		$end = ($search_arr["page"] > 1)?($search_arr["page"])*$search_arr["rows"]:$search_arr["rows"];
		$result = $this->Wds_acp_m->indenpent_mes_serach($search_arr);
                $num = $this->Wds_acp_m->indenpent_mes_serach($search_arr,-1);
		//print_r($result);exit;
		$list_info = array();
		if(!empty($result)){
			foreach ($result as $key=>$val){
				$res["id"] = $val["id"];
				if($val["type_id"] == '-1'){
					$res["pro_type"] = "微打赏-独立项目";
				}
				$pro_cuser = $this->User_m->get_user_info ( $val['user_id'] );
				$res["pro_name"] = $val["name"];
				if($val["ctime"] == "0000-00-00 00:00:00"){
					$res["create_time"] ='';
				}else{
					$res["create_time"] =$val["ctime"];
				}
				$res["start_time"] =$val["start_time"];
				$res["end_time"] =$val["end_time"];
				$res["op_user"] =$pro_cuser['nickname'];
				if($val["if_show"] == '1'){
					$res["work"] = '<a href="/weidashang/down_inden_pro/'.$val["id"].'" id="down_inden_pro" class="down_inden_pro" onclick="if(confirm(\'确实要将活动<' .$val["name"].'>下线吗？\')) return true;else return false;">下线</a>';
				}elseif($val["if_show"] == '0'){
					$res["work"] = '<a href="/weidashang/go_inden_pro/'.$val["id"].'" id="go_inden_pro" class="go_inden_pro" onclick="if(confirm(\'确实要将活动<' .$val["name"].'>上线吗？\')) return true;else return false;">上线</a>';
				}
				$logo_arr = unserialize($val["logo"]);
				$logo = cdn_url($logo_arr[0]);
				$res["logo"] = '<img src="'.$logo.'" style="width:80px;height:80px"/>';
				$res["goal"] = $val["goal"];
				$res["inner_user_num"] = $val["pay_count"];
				$res["topic_all_money"] = $val["all_amount"];
				$list_info[] = $res;
			}
		}
		//根据支持人数/钱数重新排序
		foreach($list_info as $key=>$value){
			if($search_arr["sort"] == 'inner_user_num'){
				$inner[$key] = $value['inner_user_num'];
			}elseif($search_arr["sort"] == 'topic_all_money'){
				$inner[$key] = $value['topic_all_money'];
			}
		}
		if($search_arr["order"] == 'asc'){
			array_multisort($inner, SORT_ASC,$list_info);
		}elseif($search_arr["order"] == 'desc'){
			array_multisort($inner, SORT_DESC,$list_info);
		}
			
		$diadian_list_info = array();
		$diadian_list_info["search"]= $list_info;
                $diadian_list_info["num"]= $num;
		return $diadian_list_info;

	}

	/**
	 * 独立项目下线
	 * @param type $id
	 */
	public function down_inden_pro($id){

		$down_inden_pro = $this->Wds_acp_m->down_diandian_sub($id);
		redirect("/weidashang/wds_pro_list");
		return true;

	}

	/**
	 * 独立项目上线
	 * @param type $id
	 */
	public function go_inden_pro($id){
		$up_inden_pro = $this->Wds_acp_m->updata_diandian_sub($id);
		redirect("/weidashang/wds_pro_list");
		return true;
		 
	}
        
        /**
         *微打赏-提现管理 
         */
       public function withdraw(){
           $data = array();
           $this->load->view('weidashang/withdraw', $data);
       }
       
       public function ajax_withdraw_start(){
            $res = array();
            $result = array();
            $res = $this->withdraw_start_search(1);

            $result = array(
                'total' =>$res["num"],
                'rows' =>$res["search"],
                'footer' => '',
            );
            echo json_encode($result);           
       }

	public function withdraw_start_search($mode=1){

		$search_arr["wds_id"] = isset($_POST['oid']) ? $_POST['oid'] : '';
		$search_arr["title"] = isset($_POST['topic']) ? intval($_POST['topic']): '';
		$search_arr["user_id"] = isset($_POST['st_id']) ? $_POST['st_id'] : '';
		$search_arr["st_mobile"] = isset($_POST['st_mobile']) ? $_POST['st_mobile'] : '';
		$search_arr["start_time"] = isset($_POST['play_start_time']) ? $_POST['play_start_time'] : '';
		$search_arr["end_time"] = isset($_POST['play_end_time']) ? $_POST['play_end_time'] : '';
		$search_arr["pro_status"] = isset($_POST['pro_status']) ? $_POST['pro_status'] : '';
		
		$op_id = $_SESSION['admin_id'];
		$op_man = $this->md_refund->get_op_name($_SESSION['admin_id']);
		if($mode == 2){
			$search_arr["page"] = "";
			$search_arr["rows"] = "";
		}else{
			$search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
			$search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';
		}
			
		$search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
		$search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';

		$start = ($search_arr["page"] > 1)?($search_arr["page"] -1)*$search_arr["rows"]:0;
		$end = ($search_arr["page"] > 1)?($search_arr["page"])*$search_arr["rows"]:$search_arr["rows"];
		$result = $this->Wds_acp_m->withdraw_mes_serach($search_arr);
                $num = $this->Wds_acp_m->withdraw_mes_serach($search_arr,-1);
		//print_r($result);exit;
		$list_info = array();
		if(!empty($result)){                    
			foreach ($result as $key=>$val){
                            $res['work'] = '';
                            $res['wds_id'] = $val['pro_id'];
                            $res['wds_name'] = $val['wds_title'];
                            $res['create_user_id'] = $val['user_id'];
                            $res['create_user_name'] = isset($val['nickname'])?$val['nickname']:$val['username'];
                            $res['create_user_mobile'] = $val['user_mobile'];
                            $res['wds_start_time'] = $val['start_time'];
                            $res['wds_end_time'] = $val['end_time'];
                            $res['wds_withdraw_time'] = $val['apply_withdraw_time'];
                            $res['goal'] = $val['goal'];
                            $res['withdraw_amount'] = $val['funcder_goal'];
                            $res['bank_name'] = $val['bank_type'];
                            $res['bank_num'] = $val['funder_account_no'];
                            $res['receiv_name'] = $val['funder_realname'];
                            $res['play_status'] = $val['if_remit'];
                            $res['refund_status'] = $val['if_refund'];
                            $res['with_status'] = $val['if_withdraw'];
                            $res['op_id'] = $op_id;
                            $res['op_name'] = $op_man;
                            ##提款手续费，按照1%扣除手续费；最低扣除1元手续费
                            if($val['funcder_goal'] <= 100){
                                $final_total = round(($val['funcder_goal'] - 1),2);
                            }else{
                                $final_total = round($val['funcder_goal'] - ($val['funcder_goal'] * 0.01),2);
                            }
                            $single = array(
                                'id' => $val['pro_id'],
                                'receiver' => $val['funder_realname'],
                                'subbank_name' => $val['funder_subbank_name'],
                                'bank_type' => $val['funder_bank_type'],
                                'bank_province' => $val['funder_bank_province'],
                                'bank_city' => $val['funder_bank_city'],
                                'account_no' => $val['funder_account_no'],
                                'recv_mobile' => $val['user_mobile'],
                                'acc_type' =>$val['funder_acc_type'],
                                'total' => $final_total
                            );
                            //print_r($single);exit;
                            if ($val['if_remit'] == '未打款') {                             
                                $res['work'] = "<a href='#' class='pay-editor' data-pay='" . json_encode($single) . "'>打款</a>"; 
                            }
                            if ($val['if_remit'] == '打款失败') {
                                $res['work'] = "<a href='#' class='pay-editor' data-pay='" . json_encode($single) . "'>打款</a>"; 
                                $sql = "SELECT rlog.callback AS callback FROM md_weidashang_remit_info rlog 
                    WHERE rlog.funder_serial={$val['pro_id']} AND rlog.package_id='{$val['package_id']}' ORDER BY rlog.ctime DESC";
                                $ress = $this->db->query($sql)->row_array();
                                $row['od_status'] = $ress['callback'];
                            }

                            $sql = "SELECT rchange.user_id AS ruser_id
                                FROM md_weidashang_remit_changes rchange WHERE rchange.pro_id={$val['pro_id']}";
                            $mess = $this->db->query($sql)->result_array();
                            if (!empty($mess)) {
                                $value = $val['pro_id'];
                                $res['play_detail'] = "<a href='#' class='see-detail' data-see=" . json_encode($value) . ">查看明细</a>";
                            }
                              $res['back_con'] = "<a href='/weidashang/show_back_mess?pro_id={$val['pro_id']}' class='see-backdetail'>查看订单明细</a>";    
			$list_info[] = $res;
			}
		}
		$withdraw_list_info = array();
		$withdraw_list_info["search"]= $list_info;
                $withdraw_list_info["num"]= $num;
		return $withdraw_list_info;
	}
        
        /**
         * 获取城市列表
         */
        public function ajax_getCityList(){
            $id = isset($_GET['id']) ? intval($this->input->get('id', true)) : '';
            if (empty($id)) {
                echo json_encode(array('status' => '-1', 'data' => ''));
                exit;
            }
            $openning = get_opening_config();
            $city_k = $openning[$id];
            if (empty($city_k)) {
                echo json_encode(array('status' => '-2', 'data' => ''));
                exit;
            }
            $city = get_opening_city_list();
            $str = '';
            foreach ($city_k as $k => $v) {
                $str .= '<option value="' . $v . '">' . $city[$v] . '</option>';
            }
            echo json_encode(array('status' => '0', 'data' => $str));
            exit;            
        }
        
        /**
         * 打款操作
         */
        public function ajax_pay(){
            $editor_type = $this->input->post('editor_type', true);
            switch (intval($editor_type)) {
                case 1:
                    $serial = $this->input->post('serial', true);
                    $rec_name = $this->input->post('receiver', true);
                    $bank_type = $this->input->post('bank_type', true);
                    $area = $this->input->post('area', true);
                    $city = $this->input->post('city', true);
                    $recv_mobile = $this->input->post('recv_mobile', true);
                    $rec_bankacc = $this->input->post('account_no', true);
                    $subbank_name = $this->input->post('subbank_name', true);
                    $pay_amt = $this->input->post('pay_amt', true);
                    $password = $this->input->post('password', true);
                    $acc_type = $this->input->post("acc_type", true);
                    $sql = " SELECT ef.funder_desc AS `desc`
                        FROM md_weidashang_withdraw ef WHERE ef.pro_id='{$serial}'";
                    $query = $this->db->query($sql);
                    $res = $query->row_array();
                    $singledata = array(
                        'serial' => $serial,
                        'rec_bankacc' => $rec_bankacc,
                        'bank_type' => $bank_type,
                        'rec_name' => $rec_name,
                        'pay_amt' => $pay_amt,
                        'acc_type' => $acc_type,
                        'area' => $area,
                        'city' => $city,
                        'subbank_name' => $subbank_name,
                        'desc' => $res['desc'],
                        'recv_mobile' => $recv_mobile
                    );
                    //print_r($singledata);exit;
                    $content = serialize($singledata);
                    $num = array('pay_product_num' => 1,
                        'pay_all_amount' => $singledata['pay_amt'],
                    );
                    $data = array(array($singledata), $num); //准备调用打款接口(单笔)
                    $res = $this->check_submit_status(0);
                    if ($res == false) {
                        echo json_encode(array('msg' => '操作过于频繁请一分钟后再试！', 'pay_type' => 1));
                        exit();
                    }
                    ob_start($package = $this->md_payment_batch_draw->set_pwd($password)->go($data[0]));
                    ob_end_clean();
                    //var_dump($package);exit;
                    $msg = $this->md_weidashang->write_package_log($package, $data);
                    if (!empty($msg)) {
                        $data = array('msg' => $msg, 'pay_type' => 1);
                    } else {
                        if (intval($this->input->post('if_change', true)) == 1) {
                            $ctime = date("Y-m-d H:i:s", time());
                            $change = array('pro_id' => $serial,
                                'content' => $content,
                                'ctime' => $ctime,
                                'user_id' => $_SESSION['admin_id']
                            );
                            $this->db->insert('md_weidashang_remit_changes', $change);
                        }
                        $data = array('msg' => '操作完成', 'pay_type' => 1);
                    }
                    break;
                case 2:
                    $password = $this->input->post('all_password', true);
                    $where = $this->_get_batchpay_where();
                    $data = $this->batch_get_pay($where);
                    if (!is_dir("/ROOT/log/php/wds")) {
                        mkdir("/ROOT/log/php/wds", 0755, true);
                    }
                    error_log(date("Y-m-d H:i:s") . "\t" . var_export($data, true) . "\r\n\r\n", 3, "/ROOT/log/php/wds/weidashang_var.log");
                    $res = $this->check_submit_status(1);
                    if ($res == false) {
                        echo json_encode(array('msg' => '操作过于频繁请一分钟后再试！', 'pay_type' => 2));
                        exit();
                    }
                    ob_start($package = $this->md_payment_batch_draw->set_pwd($password)->go($data[0]));
                    ob_end_clean();
                    $msg = $this->md_weidashang->write_package_log($package, $data);    
                    if (!empty($msg)) {
                        $data = array('msg' => $msg, 'pay_type' => 2);
                    } else {
                        $data = array('msg' => '操作完成', 'pay_type' => 2);
                    }
                    break;
            }
            echo json_encode($data);            
        }
    /**
     * 单笔打款
     * @param type $if_batch 0单笔 1批量
     * @return boolean
     */
    function check_submit_status($if_batch) {
        $time = time();
        switch (intval($if_batch) == 0) {
            case 0:
                $check_submit_file = "check_singlesubmit.log";
                break;
            case 1:
                $check_submit_file = "check_batchsubmit.log";
                break;
            default :
        }
        $limit_time = 30;  //限制时间
        if (file_exists($check_submit_file)) {
            $str = file_get_contents($check_submit_file);
            if ($str > ($time - $limit_time)) {
                return false;
            } else {
                file_put_contents($check_submit_file, $time);
                return true;
            }
        } else {
            file_put_contents($check_submit_file, $time);
            return true;
        }
    }
    
    /**
     * 获取批量打款的数据信息
     */
    public function ajax_get_pay() {
        $where = $this->_get_batchpay_where();
        $res = $this->batch_get_pay($where);
        echo json_encode($res[1]);
    } 
    
    /**
     * 满足批量打款 搜索的子条件
     * @return type
     */
    public function _get_batchpay_where() {
        $time = time() - 600;
        $time = date("Y-m-d H:i:s", $time);
        return $where = " AND (ef.if_withdraw=1 AND ef.if_remit=0 AND ef.apply_withdraw_time<\"{$time}\" AND ef.funder_account_no!='' AND ef.funder_realname!='' AND ef.funder_bank_type!='' AND ef.funder_bank_city!='' AND ef.funder_bank_province!='' AND ef.funder_subbank_name!='' AND ef.funder_acc_type!='') ORDER BY ef.id LIMIT 10 "; //先测试仅打10个
    }
    
    /**
     * 批量打款搜索
     * @param type $where
     * @return type
     */
    public function batch_get_pay($where) {//$limit
        $sql = "SELECT ef.pro_id AS serial,
                ef.funder_account_no AS rec_bankacc,
                ef.funder_bank_type AS bank_type,
                ef.funder_realname AS rec_name,
                ef.funder_acc_type AS acc_type,
                ef.funder_bank_province AS area,
                ef.funder_bank_city AS city,
                ef.funder_subbank_name AS subbank_name,
                ef.funder_desc AS `desc`,
                ef.funder_recv_mobile AS recv_mobile
    FROM md_weidashang_withdraw ef WHERE 1 {$where} "; //{$limit}
                    if (!is_dir("/ROOT/log/php/wds")) {
                        mkdir("/ROOT/log/php/wds", 0755, true);
                    }
                    error_log(date("Y-m-d H:i:s") . "\t" . var_export($sql, true) . "\r\n\r\n", 3, "/ROOT/log/php/wds/weidashang_withdraw_sql.log");
        $query = $this->db->query($sql);
        $rows = $query->result_array($query);
        $pay_user_num = 0;
        $pay_all_amount = 0.0;
        foreach ($rows as $key => &$row) {
            $sql = "SELECT p.all_amount AS total
            FROM md_weidashang_product p WHERE p.id='{$row['serial']}'";
            $query = $this->db->query($sql);
            $res = $query->row_array();
            $row['pay_amt'] = round($res['total'] - ( $res['total'] * 0.02 + 1 ), 2); //收取手续费后的最终打款金额
            if ($row['pay_amt'] <= 0 || $row['pay_amt'] == "") {
                unset($rows[$key]);
            }
            $pay_all_amount += $row['pay_amt'];
        }
        $pay_product_num = count($rows);
        $pay_user_num = $pay_product_num;
        $data = array('pay_product_num' => $pay_product_num,
            'pay_user_num' => $pay_user_num,
            'pay_all_amount' => $pay_all_amount,
        );
        return array($rows, $data);
    }
    
    /**
     * 获取打款明细
     */
    public function ajax_get_change_detail() {
        $id = isset($_GET['id']) ? intval($this->input->get('id', true)) : "";
        $sql = "SELECT rchange.pro_id AS serial,
                rchange.content AS content,
                rchange.ctime AS ctime,
                rchange.user_id AS user_id
            FROM md_weidashang_remit_changes rchange WHERE rchange.pro_id={$id}";
        $res = $this->db->query($sql)->result_array();
        $str = '';
        foreach ($res as &$row) {
            $row['content'] = unserialize($row['content']);
            $msg = '收款帐号:' . $row['content']['rec_bankacc'] . ',银行编码:' . $row['content']['bank_type'] . ',收款人姓名:' . $row['content']['rec_name'] . ',帐号类型:' . $row['content']['acc_type'] . ',省编码:' . $row['content']['area'] . ',城市编码:' . $row['content']['city'] . ',支行名称:' . $row['content']['subbank_name'] . ',收款手机号:' . $row['content']['recv_mobile'];
            $str .= '<tr class="each-detail"><td>' . $row['serial'] . '</td>' . '<td>' . $row['ctime'] . '</td>' . '<td>' . $row['user_id'] . '</td>' . '<td>' . $msg . '</td></tr>';
        }
        echo $str;
    }
    
    /**
     * 提现 同步
     */
    public function syn_status() {
        $syn_password = $this->input->post('syn_pwd', true); //准备调用查询接口
        $package_ids = $this->md_weidashang->get_wait_remit_package();
        $error = '';
        foreach ($package_ids as $row) {
            $res = $this->md_payment_batch_draw->set_pwd($syn_password)->query($row['package_id']);
            if (isset($res['error']) && !empty($res['error'])) {
                $data = array('status' => '-1', 'msg' => "包id:" . $row['package_id'] . ":" . $res['error']);
                $error .= "包id:" . $row['package_id'] . ":" . $res['error'];
//                echo json_encode($data);
//                exit;
            }
            $this->md_weidashang->write_syn_info($res, $row['package_id']);
        }
        $data = array('status' => '0', 'msg' => '操作完成'.$error);
        echo json_encode($data);
    }
    
    /**
     * 导出提现excel
     */
    public function export_withdraw(){
        $arr_title = array(
            "pro_id" => "项目ID",
            "wds_title" => "项目名称【项目ID】",
            "user_id" => "申请人ID",
            "nickname" => "申请人名称",
            "user_mobile" => "预留手机号",
            "start_time" => "项目开始时间",
            "end_time" => "项目结束时间",
            "apply_withdraw_time" => "提现申请时间",
            "goal" => "目标金额",
            "funcder_goal" => "实际提现金额",
            "bank_type" => "收款银行",
            "funder_account_no" => "收款账号",
            "funder_realname" => "收款人",
            "if_remit" => "打款状态",
            "if_refund" => "退款状态",
            "if_withdraw" => "申请状态",
        );

		$search_arr["wds_id"] = isset($_POST['oid']) ? $_POST['oid'] : '';
		$search_arr["title"] = isset($_POST['topic']) ? $_POST['topic']: '';
		$search_arr["user_id"] = isset($_POST['st_id']) ? $_POST['st_id'] : '';
		$search_arr["st_mobile"] = isset($_POST['st_mobile']) ? $_POST['st_mobile'] : '';
		$search_arr["start_time"] = isset($_POST['play_start_time']) ? $_POST['play_start_time'] : '';
		$search_arr["end_time"] = isset($_POST['play_end_time']) ? $_POST['play_end_time'] : '';
		$search_arr["pro_status"] = isset($_POST['pro_status']) ? $_POST['pro_status'] : '';
		$search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
		$search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';
		$search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
		$search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';

		$start = ($search_arr["page"] > 1)?($search_arr["page"] -1)*$search_arr["rows"]:0;
		$end = ($search_arr["page"] > 1)?($search_arr["page"])*$search_arr["rows"]:$search_arr["rows"];
		$result = $this->Wds_acp_m->withdraw_mes_serach($search_arr);
                for($i=0;$i<count($result);$i++){
                    $result[$i]['wds_title'] = $result[$i]['wds_title'].'【'.$result[$i]['pro_id'].'】';
                }
        $path_file = date("Y-m-d H:i:s", time()) . '.xls';
        export_to_excel($arr_title, $result, $path_file, 0);        
    }
    
    /**
     * 首页推荐的管理
     */
    public function huodong_manage(){
        set_time_limit(0);
        if ($_POST) {
            if (isset($_POST['top_sort']) && count($_POST['top_sort']) > 0) {
                foreach ($_POST['top_sort'] as $id => $item) {
                    $id = intval($id);
                    $item = intval($item);
                    $sql = "update md_weidashang_topic SET sort='{$item}'  WHERE id ='{$id}';";
                    $this->db->query($sql);
                }
            }
        }
        if (isset($_GET['id'])) {
            $sql = "update md_weidashang_topic SET if_show=0  WHERE id ='" . $_GET['id'] . "';";
            $this->db->query($sql);
            redirect('weidashang/huodong_manage');
        }
        if (isset($_GET['hide_topic'])) {
            if($_GET['hide_topic'] == 0){
                $sql = "update md_weidashang_topic SET if_show=0  WHERE 1;";
                $this->db->query($sql);

            }elseif($_GET['hide_topic'] == 1){
                $sql = "update md_weidashang_topic SET if_show=1  WHERE 1;";
                $this->db->query($sql);
                
            }
            redirect('weidashang/huodong_manage');
        }        
        $sql = "SELECT * FROM md_weidashang_topic WHERE if_show=1 ORDER BY sort DESC,id DESC";
        $data['projects'] = $this->db->query($sql)->result_array();
        //print_r($data);exit('1');
        $this->load->view('weidashang/huodong_recommend', $data);        
    }

    public function weidashang_pro_manage(){
        set_time_limit(0);
        if ($_POST) {
            if (isset($_POST['top_sort']) && count($_POST['top_sort']) > 0) {
                foreach ($_POST['top_sort'] as $id => $item) {
                    $id = intval($id);
                    $item = intval($item);
                    $sql = "update md_weidashang_product SET list_num='{$item}'  WHERE id ='{$id}';";
                    $this->db->query($sql);
                }
            }
            if (isset($_POST['preheat'])) {
                $sql = "update md_weidashang_product SET flag=REPLACE(flag,',homepage_going','')  WHERE id ='" . $_POST['preheat'] . "';";
                $this->db->query($sql);
                $sql = "update md_weidashang_product SET flag=CONCAT(flag,',homepage_going')  WHERE id ='" . $_POST['preheat'] . "';";
                $this->db->query($sql);
            }          
        }
        if (isset($_GET['id'])) {
            $sql = "update md_weidashang_product SET flag='', list_num='0'  WHERE id ='" . $_GET['id'] . "';";
            $this->db->query($sql);
            redirect('weidashang/weidashang_pro_manage');
        }
      
        $sql = "SELECT * FROM md_weidashang_product WHERE if_show=1 AND pro_type=3 AND type_id=-1 AND flag LIKE '%homepage_going%' ORDER BY list_num DESC,id DESC LIMIT 20";
        $data['projects'] = $this->db->query($sql)->result_array();
        //print_r($data);exit('1');
        $this->load->view('weidashang/weidashang_pro_manage', $data);        
    }
    
    /**
     * 订单明细
     */
    public function show_back_mess(){
           $pro_id = $_GET['pro_id'];
           $data = array();
           $data['wds_id'] = $pro_id;
           $back_sql = "SELECT b.ctime,b.amount ,u.id,u.nickname,u.username,p.all_amount,p.name,p.start_time,p.end_time FROM `md_product_back` b ";
           $back_sql .= "LEFT JOIN `md_users` u ON b.user_id=u.id ";
           $back_sql .= "LEFT JOIN `md_weidashang_product` p ON b.wds_id=p.id WHERE b.if_pay=1 AND b.wds_id={$pro_id} order by b.ctime DESC";
           $back_mess = $this->db->query($back_sql)->result_array();
           $real_all = "SELECT sum(amount) as all_ramount FROM `md_product_back` WHERE if_pay=1 AND wds_id={$pro_id}";
           $real_mes = $this->db->query($real_all)->row_array();           
           $data['back_mess'] = $back_mess;
           $data['real_mess'] = $real_mes;
           $this->load->view('weidashang/back_mess', $data);        
    } 
    /**
     * 退款管理
     */
    function refund(){
        $data = array();
        $this->load->view('weidashang/refund', $data); 
    }
    
    public function ajax_refund(){
		$res = array();
		$result = array();
		$res = $this->refund_search(1);
			
		$result = array('total' =>$res["num"],
    			'rows' =>$res["search"]
		);
			
		echo json_encode($result);
	}

	/**
	 * 筹点点后台查询详细方法
	 * Enter description here ...
	 * @param unknown_type $mode
	 */
    public function refund_search($mode = 1) {
        $search_arr["wds_name"] = isset($_POST['wds_name']) ? $_POST['wds_name'] : '';
        $search_arr["wds_id"] = isset($_POST['wds_id']) ? intval($_POST['wds_id']) : '';
        $search_arr["cuser_id"] = isset($_POST['cuser_id']) ? $_POST['cuser_id'] : '';
        $search_arr["refund_status"] = isset($_POST['refund_status']) ? $_POST['refund_status'] : '';
        if ($mode == 2) {
            $search_arr["page"] = "";
            $search_arr["rows"] = "";
        } else {
            $search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
            $search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';
        }

        $search_arr["page"] = isset($_POST['page']) ? intval($_POST['page']) : '1';
        $search_arr["rows"] = isset($_POST['rows']) ? intval($_POST['rows']) : '20';

        $start = ($search_arr["page"] > 1) ? ($search_arr["page"] - 1) * $search_arr["rows"] : 0;
        $end = ($search_arr["page"] > 1) ? ($search_arr["page"]) * $search_arr["rows"] : $search_arr["rows"];
        $result = $this->Wds_acp_m->refund_mes_serach($search_arr);
        $num = $this->Wds_acp_m->refund_mes_serach($search_arr,-1);
       // print_r($result);exit;
        $list_info = array();
        if (!empty($result)) {
            foreach ($result as $key => $val) {
                $res['wds_id'] = $val['wds_id'];
                $res['wds_name'] = $val['topic'];
                if($val['type'] == 0){
                    $res['type'] ='活动中项目';
                }else{
                    $res['type'] ='独立项目';
                } 
                $order_sql = "SELECT COUNT(bak.id) AS order_num FROM md_product_back bak WHERE (bak.wds_id='{$val['wds_id']}' AND bak.if_pay=1 AND bak.status=403)";
                //echo $order_sql;exit;
                $order_res = $this->db->query($order_sql)->row_array();
                if(!empty($order_res)){
                    $res['order_num'] = $order_res['order_num'];
                    $res['refund_orders'] = '<a href=/weidashang/show_back_mess?pro_id=' . $val['wds_id'] . '><font color="red">' . $order_res['order_num'] . '</font></a>';                   
                }else{
                    $res['order_num'] = 0;
                    $res['refund_orders'] = '<span style="color:red">0</span>';
                }
                switch($val['if_refund']){
                    case 0:
                        $res['refund_status'] ='不需要退款';
                        break;
                    case 1:
                        $res['refund_status'] ='需要退款';
                        break;
                    case 2:
                        $res['refund_status'] ='退款成功';
                        break;
                    case -1:
                        $res['refund_status'] ='部分退款';
                        break;
                }                   
                $res['start_time'] =$val['start_time'];
                $res['end_time'] =$val['end_time'];
                $res['cuser_id'] =$val['cuser_id'];
                $cuser_sql = "SELECT `username`,`mobile`,`nickname` FROM `md_users` WHERE `id`={$val['cuser_id']}";
                $cuser_info = $this->db->query($cuser_sql)->row_array();
                if(!empty($cuser_info['nickname'])){
                    $res['cuser_nickname'] =$cuser_info['nickname'];
                }else{
                    $res['cuser_nickname'] =$cuser_info['username'];
                }               
                $res['cuser_mobile'] = $cuser_info['mobile'];
                $res['goal'] =$val['goal']; 
                if(!empty($val['total'])){
                    $res['total'] =$val['total'];
                }else{
                    $res['total'] = 0;
                }                       
                $list_info[] = $res;
            }
        }
        $diadian_list_info = array();
        $diadian_list_info["search"] = $list_info;
        $diadian_list_info["num"] = $num;
        return $diadian_list_info;
    }
    
    public function ajax_batch_refund() {
        $user_id = $_SESSION['admin_id'];
	$op_man = $this->md_refund->get_op_name($_SESSION['admin_id']);
        $batch_arr = array('op_id'=>$user_id,'op_man' =>$op_man,'ctime'=>date("Y-m-d H:i:s"));
        if (!is_dir("/ROOT/log/php/wds")) {
            mkdir("/ROOT/log/php/wds", 0755, true);
        }
        error_log(var_export($batch_arr, true), 3, "/ROOT/log/php/wds/weidashang_ajax_batch_refund.log");
        $sql = "SELECT wds.id FROM md_weidashang_product wds WHERE wds.if_refund=1";
        $rows = $this->db->query($sql)->result_array();
        $batch_num = 0;
        $batch_amount = 0;
        foreach ($rows as $row) {
            $sql = "SELECT bak.id AS back_id, bak.amount AS amount, bak.wds_id FROM md_product_back bak WHERE bak.if_pay=1 AND bak.status=403 AND bak.wds_id={$row['id']}";
            $res = $this->db->query($sql)->result_array();
          //  print_r($res);exit;
            foreach ($res as $data) {
                $back_platform_sql = "SELECT pay_platform, out_trade_no FROM md_pay WHERE back_id = '{$data['trade_no']}'";
                $back_platform = $this->db->query($back_platform_sql)->row_array();
                if($back_platform['pay_platform'] == 'weixin_wap'){
                    if ($this->md_payment_weixin->refund($back_platform['out_trade_no'], $data['amount']) == TRUE) {
                        $sql = "UPDATE md_product_back SET if_pay=3,status=400 WHERE id='{$data['trade_no']}'";
                        $this->db->query($sql);
                    }
                }elseif($back_platform['pay_platform'] == 'alipay_wap'){
                    ++$batch_num;
                    $batch_amount += $data['amount'];
                    $rc = $this->refund_alipay_account($data['back_id'], $data['amount'], $data['wds_id'], $back_platform['out_trade_no'], $batch_num, $batch_amount);                                      
                }              
            }
        }
        $this->syn_refund_status();
        echo json_encode(array('msg' => '操作完成，状态已同步'));
    }
    //支付宝退款
    function refund_alipay_account($back_id, $amount, $wds_id, $pay_out_trade_no, $batch_num, $batch_amount)
    {
        $op_man = $this->md_refund->get_op_name($_SESSION['admin_id']);
        $refund_ord_info = array();
        $batch_amount = 0;
        $batch_id = $this->md_refund->get_wds_next_batch_id($wds_id);
        $batch_no = $this->md_refund->create_next_batch_no($wds_id, $batch_id, 'A');
        $refund_date = date("Y-m-d H:i:s");
        $detail_data = "";
        $trade_no = $this->md_refund->get_trade_no($back_id);
        $detail_data .= "{$trade_no}^{$amount}^众筹失败#";    
        $userinfo_sql = "SELECT u.realname as user_realname, u.mobile as user_reg_mobile FROM md_users u LEFT JOIN md_product_back bak ON bak.user_id = u.id WHERE bak.id = {$back_id}";
        $userinfo = $this->db->query($userinfo_sql)->row_array();
        $refund_ord_info[] = array(
            'batch_no' => "{$batch_no}",
            'back_id' => "{$back_id}",
            'pay_out_trade_no' => "{$pay_out_trade_no}",
            'trade_no' => "{$trade_no}",
            'refund_amount' => "{$amount}",
            'refund_rsn' => "众筹失败",
            'refund_date' => "$refund_date",
            'user_realname' => "{$userinfo['user_realname']}",
            'user_reg_mobile' => "{$userinfo['user_reg_mobile']}",
            'op_type' => 1,
            'op_reason' => "",
            'op_time' => "",
            'op_man' => "{$op_man}", // 文案??????
        );
        $detail_data = rtrim($detail_data, '#');
        // 退款
        $parm['batch_no'] = $batch_no;
        $parm['refund_date'] = $refund_date;
        $parm['batch_num'] = $batch_num;
        $parm['detail_data'] = $detail_data;
        $alipayapi_return = $this->md_refund->refund_alipayapi($parm);
        $req_status = $this->md_refund->get_refund_req_status($alipayapi_return['return_code']);
        switch ($req_status) {
        case '请求成功': // 更新状态：退款中
            foreach ($refund_ord_info as $key => $ord_info) {
                $this->Order_biz->set_oid($ord_info['back_id'])->update_status('402');
            }
            break;
        case '请求失败': // 转入线下人工退款流程
            foreach ($refund_ord_info as $key => $ord_info) {
                $refund_ord_info["$key"]['op_type'] = 11;
                $refund_ord_info["$key"]['op_reason'] = '支付宝退款请求失败';
                $refund_ord_info["$key"]['op_time'] = date("Y-m-d H:i:s");
            }
            break;
        default:
            # code...
            break;
        }

        // 保存退款信息到数据库
        $req_info = array('0' => $alipayapi_return + array('pro_id' => $pro_id, 'batch_id' => $batch_id, 'batch_amount' => $batch_amount));
        $this->md_refund->save_refund_req_log($req_info);
        $this->md_refund->save_refund_order_info($refund_ord_info);
    }
    
    public function syn_refund_status() {
         $ali_sql = "SELECT bak.* FROM md_product_back AS bak,md_pay_record_alipay ali,md_pay pay WHERE ali.merchant_out_order_no = pay.out_trade_no AND pay.back_id = bak.id AND ali.sub_trans_code_msg = '交易退款' AND bak.if_pay=1";
            $list = $this->db->query($ali_sql)->result_array();
            foreach ($list as $item) {
                $this->Order_biz->set_oid($item['id'])->update_status('400');
            }
            $bak_sql = "UPDATE md_product_back as bak,md_pay_record_alipay ali,md_pay pay SET bak.if_pay=3 WHERE ali.merchant_out_order_no=pay.out_trade_no AND pay.back_id=bak.id AND ali.sub_trans_code_msg='交易退款' AND bak.if_pay=1";
            $this->db->query($bak_sql);
        $sql = "SELECT wds.id FROM md_weidashang_product wds WHERE wds.if_refund=1";
        $rows = $this->db->query($sql)->result_array();
        foreach ($rows as $row) {
            $sql = "SELECT SUM(bak.amount) AS all_total FROM md_product_back bak WHERE bak.wds_id={$row['id']} AND bak.if_pay=3 AND bak.status=400";
            $res1 = $this->db->query($sql)->row_array();
            $all_num = $res1['all_total'];
            $sql = "SELECT all_amount AS total FROM md_weidashang_product wds WHERE wds.id={$row['id']} AND wds.if_refund=1";
            $res2 = $this->db->query($sql)->row_array();
            $num = $res2['total'];
            if ($all_num > 0) {
                if ($all_num == $num) {
                    $sql = "UPDATE md_weidashang_product SET if_refund=2 WHERE id={$row['id']}";
                    $this->db->query($sql);
                } elseif ($num > 0) {
                    $sql = "UPDATE md_weidashang_product SET if_refund=-1 WHERE id={$row['id']}";
                    $this->db->query($sql);
                }
            }
        }
        return true;
    }
    
    /**
     * 退款导出
     */
    public function export_refund() {
        $arr_title = array(
            'wds_id' => '项目编号',
            'wds_name' => '场景名称',
            'type' => '场景分类',
            'order_num' => '总订单数',
            'refund_orders' => '需要操作订单数',
            'refund_status' => '退款状态',
            'start_time' => '项目开始时间号',
            'end_time' => '项目结束时间',
            'cuser_id' => '发起人ID',
            'cuser_nickname' => '发起人名称',
            'cuser_mobile' => '发起人手机号 ',
            'goal' => '目标金额',
            'total' => '实际众筹金额'
        );
        $search_arr["wds_name"] = isset($_POST['wds_name']) ? $_POST['wds_name'] : '';
        $search_arr["wds_id"] = isset($_POST['wds_id']) ? intval($_POST['wds_id']) : '';
        $search_arr["cuser_id"] = isset($_POST['cuser_id']) ? $_POST['cuser_id'] : '';
        $search_arr["refund_status"] = isset($_POST['refund_status']) ? $_POST['refund_status'] : '';
        $result = $this->Wds_acp_m->refund_mes_serach($search_arr); 
        $list_info = array();
        if (!empty($result)) {
            foreach ($result as $key => $val) {
                $res['wds_id'] = $val['wds_id'];
                $res['wds_name'] = $val['topic'];
                if($val['type'] == 0){
                    $res['type'] ='活动中项目';
                }else{
                    $res['type'] ='独立项目';
                } 
                $order_sql = "SELECT COUNT(bak.id) AS order_num FROM md_product_back bak WHERE (bak.wds_id='{$val['wds_id']}' AND bak.if_pay=1 AND bak.status=403)";
                //echo $order_sql;exit;
                $order_res = $this->db->query($order_sql)->row_array();
                if(!empty($order_res)){
                    $res['order_num'] = $order_res['order_num'];
                    $res['refund_orders'] = $order_res['order_num'] ;                   
                }else{
                    $res['order_num'] = 0;
                    $res['refund_orders'] = '<span style="color:red">0</span>';
                }
                switch($val['if_refund']){
                    case 0:
                        $res['refund_status'] ='不需要退款';
                        break;
                    case 1:
                        $res['refund_status'] ='需要退款';
                        break;
                    case 2:
                        $res['refund_status'] ='退款成功';
                        break;
                    case -1:
                        $res['refund_status'] ='部分退款';
                        break;
                }                   
                $res['start_time'] =$val['start_time'];
                $res['end_time'] =$val['end_time'];
                $res['cuser_id'] =$val['cuser_id'];
                $cuser_sql = "SELECT `username`,`mobile`,`nickname` FROM `md_users` WHERE `id`={$val['cuser_id']}";
                $cuser_info = $this->db->query($cuser_sql)->row_array();
                if(!empty($cuser_info['nickname'])){
                    $res['cuser_nickname'] =$cuser_info['nickname'];
                }else{
                    $res['cuser_nickname'] =$cuser_info['username'];
                }               
                $res['cuser_mobile'] = $cuser_info['mobile'];
                $res['goal'] =$val['goal']; 
                $bak_sql = "SELECT SUM(bak.amount) AS total FROM md_product_back bak WHERE (bak.wds_id='{$val['wds_id']}' AND bak.if_pay=1 AND bak.status=403)";
                $bak_res = $this->db->query($bak_sql)->row_array();
                if(!empty($bak_res)){
                    $res['total'] =$bak_res['total'];
                }else{
                    $res['total'] = 0;
                }                       
                $list_info[] = $res;
            }
        }
        $path_file = date("Y-m-d H:i:s", time()) . '.xls';
        export_to_excel($arr_title, $list_info, $path_file, 0);
    }
    function export_to_excel($arr_title, $rows, $path_file, $place = 0) {
//        if (empty($arr_title) || empty($rows) || empty($path_file)) {
//            err_exit('arguments illegal', __FILE__, __FUNCTION__, __LINE__);
//        }
        //导入PHPExcel
        $CI = & get_instance();
        $CI->load->library('PHPExcel');

        // $cacheMethod = PHPExcel_CachedObjectStorageFactory:: cache_to_phpTemp;
        // $cacheSettings = array(
        //     'memoryCacheSize' => '256MB'
        // );
        // PHPExcel_Settings::setCacheStorageMethod($cacheMethod, $cacheSettings);

        $objPHPExcel = new PHPExcel();
        $objPHPExcel->getProperties()->setTitle('export')->setDescription('none');
        $objPHPExcel->setActiveSheetIndex(0);

        $row_no = 1;
        $col = 0;
        foreach ($arr_title as $k => $title) {
            $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($col, $row_no, $title);
            $col++;
        }
        $row_no++;
        foreach ($rows as $row) {
            $col = 0;
            foreach ($arr_title as $k => $title) {
                $objPHPExcel->getActiveSheet()->setCellValueByColumnAndRow($col, $row_no, ' ' . $row[$k]); //在写入Excels单元格的内容之前加一个空格，防止长数字被转化成科学计数法
                $col++;
            }
            $row_no++;
        }

        $objPHPExcel->setActiveSheetIndex(0);
        $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');
        ob_end_clean();

        if ($place == 1) {
            if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
                $path_file = iconv('utf-8', 'gbk', $path_file);  // 解决windows服务器环境下文件名乱码
            }
            $objWriter->save($path_file);
        } else {
            // Sending headers to force the user to download the file
            header('Content-Type: applicationnd.ms-excel');
            header('Content-Disposition: attachment;filename="' . $path_file);
            header('Cache-Control: max-age=0');

            $objWriter->save('php://output');
        }
    }    
}
